<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>408 æ™ºèƒ½å¤ä¹ è®¡åˆ’</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
    body {
      font-family: 'Noto Sans SC', sans-serif;
      -webkit-tap-highlight-color: transparent;
      background-color: #0f172a; /* æ·±ç©ºè“-å…œåº• */
      background-image: linear-gradient(160deg, #0f172a 0%, #131b3a 50%, #1e293b 100%);
    }
    .view-container {
      transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
    }
    .hidden-view {
      opacity: 0;
      transform: scale(0.95);
      pointer-events: none;
      position: absolute;
      width: 100%;
    }
    .list-item-animation {
      transform: translateY(20px);
      opacity: 0;
      animation: slideInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    @keyframes slideInUp {
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    .glass-card {
      background-color: rgba(30, 41, 59, 0.6); /* slate-800 with opacity */
      border: 1px solid rgba(148, 163, 184, 0.1);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 1rem;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      transition: background-color 0.3s, transform 0.3s, box-shadow 0.3s;
    }
    .glass-card:hover {
      background-color: rgba(51, 65, 85, 0.7); /* slate-700 with opacity */
    }
    .task-knob {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #94a3b8;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      position: relative;
      overflow: hidden;
    }
    .task-knob .knob-number {
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .task-knob .knob-checkmark {
      position: absolute;
      font-size: 20px;
      line-height: 1;
      color: white;
      transform: scale(0);
      opacity: 0;
      transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease;
    }
    .task-knob.completed {
      background-color: #818cf8; /* indigo-400 */
      border-color: #818cf8;
      transform: rotate(360deg) scale(1.1);
    }
    .task-knob.completed .knob-number {
      transform: scale(0);
      opacity: 0;
    }
    .task-knob.completed .knob-checkmark {
      transform: scale(1);
      opacity: 1;
    }
    .plan-text.completed {
      text-decoration: line-through;
      color: #64748b;
    }
    .modal-backdrop.hidden { display: none; }
    .modal-content {
      animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slide-up {
      from { transform: translateY(50px) scale(0.95); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top: 4px solid #c7d2fe; /* indigo-200 */
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    input[type=range] {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 8px; background: #334155;
      border-radius: 5px; outline: none; transition: background 0.3s;
    }
    input[type=range]:hover { background: #475569; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 24px; height: 24px; background: #a5b4fc;
      cursor: pointer; border-radius: 50%; border: 4px solid #1e293b;
      box-shadow: 0 0 10px rgba(165, 180, 252, 0.5);
    }
    input[type=range]::-moz-range-thumb {
      width: 24px; height: 24px; background: #a5b4fc;
      cursor: pointer; border-radius: 50%; border: 4px solid #1e293b;
      box-shadow: 0 0 10px rgba(165, 180, 252, 0.5);
    }
    .weight-btn-group button.active {
      background-color: #818cf8;
      color: #1e293b;
      font-weight: bold;
      box-shadow: 0 0 15px rgba(129, 140, 248, 0.4);
    }
    .sub-topic-label input:checked + span {
      background-color: #818cf8;
      border-color: #818cf8;
      color: #1e293b;
      font-weight: 500;
    }
    .main-cta-btn {
      background-image: linear-gradient(to right, #818cf8 0%, #c084fc 51%, #818cf8 100%);
      background-size: 200% auto;
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 5px 15px rgba(192, 132, 252, 0.2);
    }
    .main-cta-btn:hover {
      background-position: right center;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(192, 132, 252, 0.3);
    }
  </style>
</head>
<body class="bg-slate-900 text-gray-300 flex items-center justify-center min-h-screen p-4">
<div class="w-full max-w-4xl mx-auto relative">
  <header class="fixed top-0 left-0 right-0 p-4 max-w-4xl mx-auto z-10 flex justify-between items-center">
    <div class="text-left">
      <h1 class="text-xl font-bold text-white tracking-wider">408 æ™ºèƒ½å¤ä¹ </h1>
      <p class="text-xs text-slate-400">CS408 Smart Review</p>
    </div>
    <button id="settings-icon" class="text-slate-400 hover:text-white transition-colors p-2 rounded-full hover:bg-slate-700/50">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
    </button>
  </header>

  <main class="pt-24 pb-12">
    <div id="dashboard-container" class="view-container text-center"></div>
    <div id="settings-container" class="view-container hidden-view w-full text-left"></div>
    <div id="plan-container" class="view-container hidden-view w-full text-left"></div>
    <div id="stats-main-container" class="view-container hidden-view w-full text-left"></div>
    <div id="chapter-detail-container" class="view-container hidden-view w-full text-left"></div>
    <div id="timeline-container" class="view-container hidden-view w-full text-left"></div>
    <div id="past-plan-container" class="view-container hidden-view w-full text-left"></div>
    <div id="question-history-container" class="view-container hidden-view w-full text-left"></div>
    <div id="summary-container" class="view-container hidden-view w-full text-left"></div>
  </main>
</div>

<!-- Modals -->
<div id="ai-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
  <div id="ai-modal-content" class="modal-content glass-card w-full max-w-2xl max-h-[80vh] flex flex-col">
    <div class="flex justify-between items-center p-4 border-b border-slate-700/50">
      <h3 id="ai-modal-title" class="text-xl font-bold text-white"></h3>
      <button class="modal-close text-slate-400 hover:text-white">&times;</button>
    </div>
    <div class="p-6 overflow-y-auto"><div id="ai-loading" class="flex flex-col items-center justify-center text-center"><div class="spinner"></div><p class="mt-4 text-slate-300">AI æ­£åœ¨æ€è€ƒä¸­...</p></div><div id="ai-result" class="text-slate-300 whitespace-pre-wrap prose prose-invert prose-p:text-slate-300 prose-strong:text-white"></div></div>
  </div>
</div>

<div id="notes-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
  <div id="notes-modal-content" class="modal-content glass-card w-full max-w-2xl flex flex-col">
    <div class="flex justify-between items-center p-4 border-b border-slate-700/50"><h3 id="notes-modal-title" class="text-xl font-bold text-white"></h3><button class="modal-close text-slate-400 hover:text-white">&times;</button></div>
    <div class="p-6">
      <textarea id="notes-textarea" class="w-full h-48 bg-slate-900/80 text-slate-200 p-3 rounded-md focus:ring-2 focus:ring-indigo-400 border border-slate-700/50" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ç¬”è®°ã€æ€»ç»“æˆ–ç–‘é—®..."></textarea>
      <p id="notes-error" class="text-red-400 text-sm mt-2 hidden"></p>
      <div class="flex justify-between items-center mt-4">
        <button id="ai-polish-btn" class="bg-purple-600/80 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-600/100 transition-colors flex items-center space-x-2">
          <span id="ai-polish-text">âœ¨ AI æ¶¦è‰²</span>
          <div id="ai-polish-spinner" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
        </button>
        <button id="save-note-btn" class="bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-400 transition-colors">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<div id="question-options-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
  <div id="question-options-modal-content" class="modal-content glass-card w-full max-w-2xl flex flex-col">
    <div class="flex justify-between items-center p-4 border-b border-slate-700/50"><h3 id="question-options-modal-title" class="text-xl font-bold text-white"></h3><button class="modal-close text-slate-400 hover:text-white">&times;</button></div>
    <div class="p-6 space-y-4">
      <div>
        <h4 class="font-semibold text-lg text-white mb-2">é€‰æ‹©æ ¸å¿ƒè€ƒç‚¹ (å¯å¤šé€‰)</h4>
        <div id="sub-topics-list" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto p-2 bg-slate-900/50 rounded-md"></div>
        <div class="flex justify-end mt-2"><label class="sub-topic-label flex items-center"><input type="checkbox" id="select-all-topics" class="hidden"><span class="border-2 border-slate-600 rounded-full px-3 py-1 text-sm cursor-pointer hover:bg-slate-700">å…¨é€‰</span></label></div>
      </div>
      <div class="border-t border-slate-700/50 pt-4">
        <h4 class="font-semibold text-lg text-white mb-2">é€‰æ‹©å‡ºé¢˜æ¨¡å¼</h4>
        <label class="flex items-center space-x-3 p-3 bg-slate-900/50 rounded-md hover:bg-slate-700/80 cursor-pointer transition-colors">
          <input type="checkbox" id="cross-topic-checkbox" class="w-5 h-5 bg-slate-700 rounded text-indigo-400 focus:ring-indigo-400 border-slate-600">
          <div><span class="font-bold text-indigo-400">è·¨çŸ¥è¯†ç‚¹ç»¼åˆè€ƒå¯Ÿ</span><p class="text-xs text-slate-400">AIå°†ç»“åˆä»Šå¤©å¤ä¹ çš„å…¶ä»–å†…å®¹ï¼Œç”Ÿæˆä¸€é“ç»¼åˆåº”ç”¨é¢˜</p></div>
        </label>
      </div>
      <p id="question-options-error" class="text-red-400 text-sm text-center hidden"></p>
      <button id="generate-question-btn" class="w-full bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-400 transition-colors flex items-center justify-center space-x-2">
        <span id="generate-q-text">ğŸš€ ç”Ÿæˆé¢˜ç›®</span>
        <div id="generate-q-spinner" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
      </button>
    </div>
  </div>
</div>

<div id="api-key-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
  <div id="api-key-modal-content" class="modal-content glass-card w-full max-w-md">
    <div class="p-8 text-center">
      <h3 class="text-2xl font-bold text-white mb-4">é…ç½® AI åŠ©æ‰‹</h3>
      <p class="text-slate-400 mb-6">ä¸ºäº†ä½¿ç”¨ AI åŠŸèƒ½ï¼Œè¯·è¾“å…¥æ‚¨çš„ Google Gemini API å¯†é’¥ã€‚æ‚¨å¯ä»¥ä» Google AI Studio å…è´¹è·å–ã€‚</p>
      <input type="password" id="api-key-input" class="w-full bg-slate-900/80 text-slate-200 p-3 rounded-md focus:ring-2 focus:ring-indigo-400 border border-slate-700/50" placeholder="ç²˜è´´æ‚¨çš„ API å¯†é’¥">
      <p id="api-key-error" class="text-red-400 text-sm mt-2 hidden"></p>
      <div class="mt-6 flex justify-end space-x-3">
        <button id="api-key-later" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors">ç¨åè®¾ç½®</button>
        <button id="save-api-key-btn" class="bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-400 transition-colors">ä¿å­˜å¯†é’¥</button>
      </div>
    </div>
  </div>
</div>

<div id="confirm-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
  <div id="confirm-modal-content" class="modal-content glass-card w-full max-w-sm">
    <div class="p-8 text-center">
      <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-4"></h3>
      <p id="confirm-modal-text" class="text-slate-400 mb-6"></p>
      <div class="flex justify-center space-x-4">
        <button id="confirm-cancel-btn" class="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition-colors">å–æ¶ˆ</button>
        <button id="confirm-ok-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-500 transition-colors">ç¡®å®š</button>
      </div>
    </div>
  </div>
</div>

<div id="learning-card-backdrop" class="modal-backdrop fixed inset-0 bg-black/80 backdrop-blur-lg flex items-center justify-center p-4 hidden z-50">
  <div id="learning-card-content" class="modal-content glass-card w-full max-w-4xl h-[85vh] flex flex-col">
    <div class="flex justify-between items-center p-4 border-b border-slate-700/50 flex-shrink-0">
      <h3 id="learning-card-title" class="text-xl font-bold text-white">æ²‰æµ¸å¼å­¦ä¹ </h3>
      <button class="modal-close text-slate-400 hover:text-white">&times;</button>
    </div>
    <div class="flex-grow p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 overflow-y-auto">
      <div class="flex flex-col">
        <h4 class="text-lg font-semibold text-white mb-3">æˆ‘çš„ç¬”è®°</h4>
        <textarea id="learning-card-notes" class="w-full flex-grow bg-slate-900/80 text-slate-200 p-3 rounded-md focus:ring-2 focus:ring-indigo-400 border border-slate-700/50" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ç¬”è®°ã€æ€»ç»“æˆ–ç–‘é—®..."></textarea>
        <div class="flex justify-between items-center mt-4">
          <button id="learning-card-polish-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-500 transition-colors flex items-center space-x-2">
            <span>âœ¨ AI æ¶¦è‰²</span>
          </button>
          <button id="learning-card-save-note-btn" class="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition-colors">ä¿å­˜ç¬”è®°</button>
        </div>
      </div>
      <div class="flex flex-col space-y-4">
        <h4 class="text-lg font-semibold text-white mb-0">AI äº’åŠ¨åŒº</h4>
        <div id="learning-card-ai-output" class="flex-grow bg-slate-900/50 rounded-lg p-4 overflow-y-auto text-slate-300 whitespace-pre-wrap prose prose-invert prose-p:text-slate-300 prose-strong:text-white">è¯·é€‰æ‹©ä¸€ä¸ª AI å·¥å…·å¼€å§‹å­¦ä¹ ...</div>
        <div class="grid grid-cols-3 gap-2">
          <button class="learning-card-ai-btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-3 rounded-lg transition-colors" data-type="explain">æ·±å…¥è§£æ</button>
          <button class="learning-card-ai-btn bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-3 rounded-lg transition-colors" data-type="question">éšå ‚ç»ƒä¹ </button>
          <button class="learning-card-ai-btn bg-rose-600 hover:bg-rose-500 text-white font-bold py-2 px-3 rounded-lg transition-colors" data-type="mnemonic">åŠ©è®°æç¤º</button>
        </div>
      </div>
    </div>
    <div class="p-4 bg-slate-900/50 border-t border-slate-700/50 flex-shrink-0">
      <button id="learning-card-complete-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-indigo-500 transition-all">æˆ‘å·²æŒæ¡ï¼Œå®Œæˆæœ¬èŠ‚</button>
    </div>
  </div>
</div>

<div id="toast-notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>


<script>
  // --- æ•°æ®å®šä¹‰åŒº ---
  const SYLLABUS = [
    // æ•°æ®ç»“æ„
    ["æ•°æ®ç»“æ„", "ç¬¬1ç«  ç»ªè®º", "1.1 æ•°æ®ç»“æ„çš„åŸºæœ¬æ¦‚å¿µ", 25, ["ds_ch1_s1"], ["åŸºæœ¬æ¦‚å¿µå’Œæœ¯è¯­", "æ•°æ®ç»“æ„ä¸‰è¦ç´ "]],
    ["æ•°æ®ç»“æ„", "ç¬¬1ç«  ç»ªè®º", "1.2 ç®—æ³•å’Œç®—æ³•è¯„ä»·", 25, ["ds_ch1_s2"], ["ç®—æ³•çš„åŸºæœ¬æ¦‚å¿µ", "ç®—æ³•æ•ˆç‡çš„åº¦é‡"]],
    ["æ•°æ®ç»“æ„", "ç¬¬2ç«  çº¿æ€§è¡¨", "2.1 çº¿æ€§è¡¨çš„å®šä¹‰å’ŒåŸºæœ¬æ“ä½œ", 20, ["ds_ch2_s1"], ["çº¿æ€§è¡¨çš„å®šä¹‰", "çº¿æ€§è¡¨çš„åŸºæœ¬æ“ä½œ"]],
    ["æ•°æ®ç»“æ„", "ç¬¬2ç«  çº¿æ€§è¡¨", "2.2 çº¿æ€§è¡¨çš„é¡ºåºè¡¨ç¤º", 30, ["ds_ch2_s2"], ["é¡ºåºè¡¨çš„å®šä¹‰", "é¡ºåºè¡¨ä¸ŠåŸºæœ¬æ“ä½œçš„å®ç°"]],
    ["æ•°æ®ç»“æ„", "ç¬¬2ç«  çº¿æ€§è¡¨", "2.3 çº¿æ€§è¡¨çš„é“¾å¼è¡¨ç¤º", 35, ["ds_ch2_s3"], ["å•é“¾è¡¨çš„å®šä¹‰", "å•é“¾è¡¨ä¸ŠåŸºæœ¬æ“ä½œçš„å®ç°", "åŒé“¾è¡¨", "å¾ªç¯é“¾è¡¨", "é™æ€é“¾è¡¨", "é¡ºåºè¡¨å’Œé“¾è¡¨çš„æ¯”è¾ƒ"]],
    ["æ•°æ®ç»“æ„", "ç¬¬3ç«  æ ˆã€é˜Ÿåˆ—å’Œæ•°ç»„", "3.1 æ ˆ", 30, ["ds_ch3_s1"], ["æ ˆçš„åŸºæœ¬æ¦‚å¿µ", "æ ˆçš„é¡ºåºå­˜å‚¨ç»“æ„", "æ ˆçš„é“¾å¼å­˜å‚¨ç»“æ„"]],
    ["æ•°æ®ç»“æ„", "ç¬¬3ç«  æ ˆã€é˜Ÿåˆ—å’Œæ•°ç»„", "3.2 é˜Ÿåˆ—", 30, ["ds_ch3_s2"], ["é˜Ÿåˆ—çš„åŸºæœ¬æ¦‚å¿µ", "é˜Ÿåˆ—çš„é¡ºåºå­˜å‚¨ç»“æ„", "é˜Ÿåˆ—çš„é“¾å¼å­˜å‚¨ç»“æ„", "åŒç«¯é˜Ÿåˆ—"]],
    ["æ•°æ®ç»“æ„", "ç¬¬3ç«  æ ˆã€é˜Ÿåˆ—å’Œæ•°ç»„", "3.3 æ ˆå’Œé˜Ÿåˆ—çš„åº”ç”¨", 40, ["ds_ch3_s3"], ["æ ˆåœ¨æ‹¬å·åŒ¹é…ä¸­çš„åº”ç”¨", "æ ˆåœ¨è¡¨è¾¾å¼æ±‚å€¼ä¸­çš„åº”ç”¨", "æ ˆåœ¨é€’å½’ä¸­çš„åº”ç”¨", "é˜Ÿåˆ—åœ¨å±‚æ¬¡éå†ä¸­çš„åº”ç”¨", "é˜Ÿåˆ—åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­çš„åº”ç”¨"]],
    ["æ•°æ®ç»“æ„", "ç¬¬3ç«  æ ˆã€é˜Ÿåˆ—å’Œæ•°ç»„", "3.4 æ•°ç»„å’Œç‰¹æ®ŠçŸ©é˜µ", 30, ["ds_ch3_s4"], ["æ•°ç»„çš„å®šä¹‰", "æ•°ç»„çš„å­˜å‚¨ç»“æ„", "ç‰¹æ®ŠçŸ©é˜µçš„å‹ç¼©å­˜å‚¨", "ç¨€ç–çŸ©é˜µ"]],
    ["æ•°æ®ç»“æ„", "ç¬¬4ç«  ä¸²", "4.1 ä¸²çš„å®šä¹‰å’Œå®ç°", 25, ["ds_ch4_s1"], ["ä¸²çš„å®šä¹‰", "ä¸²çš„åŸºæœ¬æ“ä½œ", "ä¸²çš„å­˜å‚¨ç»“æ„"]],
    ["æ•°æ®ç»“æ„", "ç¬¬4ç«  ä¸²", "4.2 ä¸²çš„æ¨¡å¼åŒ¹é…", 40, ["ds_ch4_s2"], ["ç®€å•çš„æ¨¡å¼åŒ¹é…ç®—æ³•", "KMPç®—æ³•", "KMPç®—æ³•çš„è¿›ä¸€æ­¥ä¼˜åŒ–"]],
    ["æ•°æ®ç»“æ„", "ç¬¬5ç«  æ ‘ä¸äºŒå‰æ ‘", "5.1 æ ‘çš„åŸºæœ¬æ¦‚å¿µ", 20, ["ds_ch5_s1"], ["æ ‘çš„å®šä¹‰", "åŸºæœ¬æœ¯è¯­", "æ ‘çš„æ€§è´¨"]],
    ["æ•°æ®ç»“æ„", "ç¬¬5ç«  æ ‘ä¸äºŒå‰æ ‘", "5.2 äºŒå‰æ ‘çš„æ¦‚å¿µ", 25, ["ds_ch5_s2"], ["äºŒå‰æ ‘çš„å®šä¹‰åŠå…¶ä¸»è¦ç‰¹æ€§", "äºŒå‰æ ‘çš„å­˜å‚¨ç»“æ„"]],
    ["æ•°æ®ç»“æ„", "ç¬¬5ç«  æ ‘ä¸äºŒå‰æ ‘", "5.3 äºŒå‰æ ‘çš„éå†å’Œçº¿ç´¢äºŒå‰æ ‘", 35, ["ds_ch5_s3"], ["äºŒå‰æ ‘çš„éå†", "çº¿ç´¢äºŒå‰æ ‘"]],
    ["æ•°æ®ç»“æ„", "ç¬¬5ç«  æ ‘ä¸äºŒå‰æ ‘", "5.4 æ ‘ã€æ£®æ—", 30, ["ds_ch5_s4"], ["æ ‘çš„å­˜å‚¨ç»“æ„", "æ ‘ã€æ£®æ—ä¸äºŒå‰æ ‘çš„è½¬æ¢", "æ ‘å’Œæ£®æ—çš„éå†"]],
    ["æ•°æ®ç»“æ„", "ç¬¬5ç«  æ ‘ä¸äºŒå‰æ ‘", "5.5 æ ‘ä¸äºŒå‰æ ‘çš„åº”ç”¨", 35, ["ds_ch5_s5"], ["å“ˆå¤«æ›¼æ ‘å’Œå“ˆå¤«æ›¼ç¼–ç ", "å¹¶æŸ¥é›†"]],
    ["æ•°æ®ç»“æ„", "ç¬¬6ç«  å›¾", "6.1 å›¾çš„åŸºæœ¬æ¦‚å¿µ", 20, ["ds_ch6_s1"], ["å›¾çš„å®šä¹‰"]],
    ["æ•°æ®ç»“æ„", "ç¬¬6ç«  å›¾", "6.2 å›¾çš„å­˜å‚¨åŠåŸºæœ¬æ“ä½œ", 30, ["ds_ch6_s2"], ["é‚»æ¥çŸ©é˜µæ³•", "é‚»æ¥è¡¨æ³•", "åå­—é“¾è¡¨", "é‚»æ¥å¤šé‡è¡¨", "å›¾çš„åŸºæœ¬æ“ä½œ"]],
    ["æ•°æ®ç»“æ„", "ç¬¬6ç«  å›¾", "6.3 å›¾çš„éå†", 30, ["ds_ch6_s3"], ["å¹¿åº¦ä¼˜å…ˆæœç´¢", "æ·±åº¦ä¼˜å…ˆæœç´¢", "å›¾çš„éå†ä¸å›¾çš„è¿é€šæ€§"]],
    ["æ•°æ®ç»“æ„", "ç¬¬6ç«  å›¾", "6.4 å›¾çš„åº”ç”¨", 40, ["ds_ch6_s4"], ["æœ€å°ç”Ÿæˆæ ‘", "æœ€çŸ­è·¯å¾„", "æœ‰å‘æ— ç¯å›¾æè¿°è¡¨è¾¾å¼", "æ‹“æ‰‘æ’åº", "å…³é”®è·¯å¾„"]],
    ["æ•°æ®ç»“æ„", "ç¬¬7ç«  æŸ¥æ‰¾", "7.1 æŸ¥æ‰¾çš„åŸºæœ¬æ¦‚å¿µ", 20, ["ds_ch7_s1"], ["æŸ¥æ‰¾çš„å®šä¹‰"]],
    ["æ•°æ®ç»“æ„", "ç¬¬7ç«  æŸ¥æ‰¾", "7.2 é¡ºåºæŸ¥æ‰¾å’ŒæŠ˜åŠæŸ¥æ‰¾", 30, ["ds_ch7_s2"], ["é¡ºåºæŸ¥æ‰¾", "æŠ˜åŠæŸ¥æ‰¾", "åˆ†å—æŸ¥æ‰¾"]],
    ["æ•°æ®ç»“æ„", "ç¬¬7ç«  æŸ¥æ‰¾", "7.3 æ ‘å½¢æŸ¥æ‰¾", 35, ["ds_ch7_s3"], ["äºŒå‰æ’åºæ ‘(BST)", "å¹³è¡¡äºŒå‰æ ‘", "çº¢é»‘æ ‘"]],
    ["æ•°æ®ç»“æ„", "ç¬¬7ç«  æŸ¥æ‰¾", "7.4 Bæ ‘å’ŒB+æ ‘", 35, ["ds_ch7_s4"], ["Bæ ‘åŠå…¶åŸºæœ¬æ“ä½œ", "B+æ ‘çš„åŸºæœ¬æ¦‚å¿µ"]],
    ["æ•°æ®ç»“æ„", "ç¬¬7ç«  æŸ¥æ‰¾", "7.5 æ•£åˆ—(Hash)è¡¨", 35, ["ds_ch7_s5"], ["æ•£åˆ—è¡¨çš„åŸºæœ¬æ¦‚å¿µ", "æ•£åˆ—å‡½æ•°çš„æ„é€ æ–¹æ³•", "å¤„ç†å†²çªçš„æ–¹æ³•", "æ•£åˆ—æŸ¥æ‰¾åŠæ€§èƒ½åˆ†æ"]],
    ["æ•°æ®ç»“æ„", "ç¬¬8ç«  æ’åº", "8.1 æ’åºçš„åŸºæœ¬æ¦‚å¿µ", 20, ["ds_ch8_s1"], ["æ’åºçš„å®šä¹‰"]],
    ["æ•°æ®ç»“æ„", "ç¬¬8ç«  æ’åº", "8.2 æ’å…¥æ’åº", 30, ["ds_ch8_s2"], ["ç›´æ¥æ’å…¥æ’åº", "æŠ˜åŠæ’å…¥æ’åº", "å¸Œå°”æ’åº"]],
    ["æ•°æ®ç»“æ„", "ç¬¬8ç«  æ’åº", "8.3 äº¤æ¢æ’åº", 30, ["ds_ch8_s3"], ["å†’æ³¡æ’åº", "å¿«é€Ÿæ’åº"]],
    ["æ•°æ®ç»“æ„", "ç¬¬8ç«  æ’åº", "8.4 é€‰æ‹©æ’åº", 30, ["ds_ch8_s4"], ["ç®€å•é€‰æ‹©æ’åº", "å †æ’åº"]],
    ["æ•°æ®ç»“æ„", "ç¬¬8ç«  æ’åº", "8.5 å½’å¹¶æ’åºã€åŸºæ•°æ’åºå’Œè®¡æ•°æ’åº", 30, ["ds_ch8_s5"], ["å½’å¹¶æ’åº", "åŸºæ•°æ’åº", "è®¡æ•°æ’åº"]],
    ["æ•°æ®ç»“æ„", "ç¬¬8ç«  æ’åº", "8.6 å„ç§å†…éƒ¨æ’åºç®—æ³•çš„æ¯”è¾ƒåŠåº”ç”¨", 25, ["ds_ch8_s6"], ["å†…éƒ¨æ’åºç®—æ³•çš„æ¯”è¾ƒ", "å†…éƒ¨æ’åºç®—æ³•çš„åº”ç”¨"]],
    ["æ•°æ®ç»“æ„", "ç¬¬8ç«  æ’åº", "8.7 å¤–éƒ¨æ’åº", 35, ["ds_ch8_s7"], ["å¤–éƒ¨æ’åºçš„åŸºæœ¬æ¦‚å¿µ", "å¤–éƒ¨æ’åºçš„æ–¹æ³•", "å¤šè·¯å¹³è¡¡å½’å¹¶ä¸è´¥è€…æ ‘", "ç½®æ¢-é€‰æ‹©æ’åº", "æœ€ä½³å½’å¹¶æ ‘"]],
    ["è®¡ç»„", "ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°", "1.1 è®¡ç®—æœºå‘å±•å†ç¨‹", 20, ["co_ch1_s1"], ["è®¡ç®—æœºç¡¬ä»¶çš„å‘å±•", "è®¡ç®—æœºè½¯ä»¶çš„å‘å±•"]],
    ["è®¡ç»„", "ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°", "1.2 è®¡ç®—æœºç³»ç»Ÿå±‚æ¬¡ç»“æ„", 30, ["co_ch1_s2"], ["è®¡ç®—æœºç³»ç»Ÿçš„ç»„æˆ", "è®¡ç®—æœºç¡¬ä»¶", "è®¡ç®—æœºè½¯ä»¶", "è®¡ç®—æœºç³»ç»Ÿçš„å±‚æ¬¡ç»“æ„", "è®¡ç®—æœºç³»ç»Ÿçš„å·¥ä½œåŸç†"]],
    ["è®¡ç»„", "ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°", "1.3 è®¡ç®—æœºçš„æ€§èƒ½æŒ‡æ ‡", 25, ["co_ch1_s3"], ["è®¡ç®—æœºçš„ä¸»è¦æ€§èƒ½æŒ‡æ ‡", "å‡ ä¸ªä¸“ä¸šæœ¯è¯­"]],
    ["è®¡ç»„", "ç¬¬2ç«  æ•°æ®çš„è¡¨ç¤ºå’Œè¿ç®—", "2.1 æ•°åˆ¶ä¸ç¼–ç ", 30, ["co_ch2_s1"], ["è¿›ä½è®¡æ•°åˆ¶åŠå…¶ç›¸äº’è½¬æ¢", "å®šç‚¹æ•°çš„ç¼–ç è¡¨ç¤º", "æ•´æ•°çš„è¡¨ç¤º", "Cè¯­è¨€ä¸­çš„æ•´æ•°ç±»å‹åŠç±»å‹è½¬æ¢"]],
    ["è®¡ç»„", "ç¬¬2ç«  æ•°æ®çš„è¡¨ç¤ºå’Œè¿ç®—", "2.2 è¿ç®—æ–¹æ³•å’Œè¿ç®—ç”µè·¯", 35, ["co_ch2_s2"], ["åŸºæœ¬è¿ç®—éƒ¨ä»¶", "å®šç‚¹æ•°çš„ç§»ä½è¿ç®—", "å®šç‚¹æ•°çš„åŠ å‡è¿ç®—", "å®šç‚¹æ•°çš„ä¹˜é™¤è¿ç®—"]],
    ["è®¡ç»„", "ç¬¬2ç«  æ•°æ®çš„è¡¨ç¤ºå’Œè¿ç®—", "2.3 æµ®ç‚¹æ•°çš„è¡¨ç¤ºä¸è¿ç®—", 35, ["co_ch2_s3"], ["æµ®ç‚¹æ•°çš„è¡¨ç¤º", "æµ®ç‚¹æ•°çš„åŠ å‡è¿ç®—", "Cè¯­è¨€ä¸­çš„æµ®ç‚¹æ•°ç±»å‹", "æ•°æ®çš„å¤§å°ç«¯å’Œå¯¹é½å­˜å‚¨"]],
    ["è®¡ç»„", "ç¬¬3ç«  å­˜å‚¨ç³»ç»Ÿ", "3.1 å­˜å‚¨å™¨æ¦‚è¿°", 20, ["co_ch3_s1"], ["å­˜å‚¨å™¨çš„åˆ†ç±»", "å­˜å‚¨å™¨çš„æ€§èƒ½æŒ‡æ ‡", "å¤šçº§å±‚æ¬¡çš„å­˜å‚¨ç³»ç»Ÿ"]],
    ["è®¡ç»„", "ç¬¬3ç«  å­˜å‚¨ç³»ç»Ÿ", "3.2 ä¸»å­˜å‚¨å™¨", 30, ["co_ch3_s2"], ["SRAM èŠ¯ç‰‡å’ŒDRAMèŠ¯ç‰‡", "åªè¯»å­˜å‚¨å™¨", "ä¸»å­˜å‚¨å™¨çš„åŸºæœ¬ç»„æˆ", "å¤šæ¨¡å—å­˜å‚¨å™¨"]],
    ["è®¡ç»„", "ç¬¬3ç«  å­˜å‚¨ç³»ç»Ÿ", "3.3 ä¸»å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥", 30, ["co_ch3_s3"], ["è¿æ¥åŸç†", "ä¸»å­˜å®¹é‡çš„æ‰©å±•", "å­˜å‚¨èŠ¯ç‰‡çš„åœ°å€åˆ†é…å’Œç‰‡é€‰", "å­˜å‚¨å™¨ä¸CPUçš„è¿æ¥"]],
    ["è®¡ç»„", "ç¬¬3ç«  å­˜å‚¨ç³»ç»Ÿ", "3.4 å¤–éƒ¨å­˜å‚¨å™¨", 25, ["co_ch3_s4"], ["ç£ç›˜å­˜å‚¨å™¨", "å›ºæ€ç¡¬ç›˜"]],
    ["è®¡ç»„", "ç¬¬3ç«  å­˜å‚¨ç³»ç»Ÿ", "3.5 é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨", 40, ["co_ch3_s5"], ["ç¨‹åºè®¿é—®çš„å±€éƒ¨æ€§åŸç†", "Cacheçš„åŸºæœ¬å·¥ä½œåŸç†", "Cacheå’Œä¸»å­˜çš„æ˜ å°„æ–¹å¼", "Cacheä¸­ä¸»å­˜å—çš„æ›¿æ¢ç®—æ³•", "Cacheçš„ä¸€è‡´æ€§é—®é¢˜"]],
    ["è®¡ç»„", "ç¬¬3ç«  å­˜å‚¨ç³»ç»Ÿ", "3.6 è™šæ‹Ÿå­˜å‚¨å™¨", 35, ["co_ch3_s6"], ["è™šæ‹Ÿå­˜å‚¨å™¨çš„åŸºæœ¬æ¦‚å¿µ", "é¡µå¼è™šæ‹Ÿå­˜å‚¨å™¨", "æ®µå¼è™šæ‹Ÿå­˜å‚¨å™¨", "æ®µé¡µå¼è™šæ‹Ÿå­˜å‚¨å™¨", "è™šæ‹Ÿå­˜å‚¨å™¨ä¸Cacheçš„æ¯”è¾ƒ"]],
    ["è®¡ç»„", "ç¬¬4ç«  æŒ‡ä»¤ç³»ç»Ÿ", "4.1 æŒ‡ä»¤ç³»ç»Ÿ", 30, ["co_ch4_s1"], ["æŒ‡ä»¤é›†ä½“ç³»ç»“æ„", "æŒ‡ä»¤çš„åŸºæœ¬æ ¼å¼", "å®šé•¿æ“ä½œç æŒ‡ä»¤æ ¼å¼", "æ‰©å±•æ“ä½œç æŒ‡ä»¤æ ¼å¼", "æŒ‡ä»¤çš„æ“ä½œç±»å‹"]],
    ["è®¡ç»„", "ç¬¬4ç«  æŒ‡ä»¤ç³»ç»Ÿ", "4.2 æŒ‡ä»¤çš„å¯»å€æ–¹å¼", 35, ["co_ch4_s2"], ["æŒ‡ä»¤å¯»å€å’Œæ•°æ®å¯»å€", "å¸¸è§çš„æ•°æ®å¯»å€æ–¹å¼"]],
    ["è®¡ç»„", "ç¬¬4ç«  æŒ‡ä»¤ç³»ç»Ÿ", "4.3 ç¨‹åºçš„æœºå™¨çº§ä»£ç è¡¨ç¤º", 30, ["co_ch4_s3"], ["å¸¸ç”¨æ±‡ç¼–æŒ‡ä»¤ä»‹ç»", "é€‰æ‹©è¯­å¥çš„æœºå™¨çº§è¡¨ç¤º", "å¾ªç¯è¯­å¥çš„æœºå™¨çº§è¡¨ç¤º", "è¿‡ç¨‹è°ƒç”¨çš„æœºå™¨çº§è¡¨ç¤º"]],
    ["è®¡ç»„", "ç¬¬4ç«  æŒ‡ä»¤ç³»ç»Ÿ", "4.4 CISCå’ŒRISCçš„åŸºæœ¬æ¦‚å¿µ", 25, ["co_ch4_s4"], ["å¤æ‚æŒ‡ä»¤ç³»ç»Ÿè®¡ç®—æœº(CISC)", "ç²¾ç®€æŒ‡ä»¤ç³»ç»Ÿè®¡ç®—æœº(RISC)", "CISCå’ŒRISCçš„æ¯”è¾ƒ"]],
    ["è®¡ç»„", "ç¬¬5ç«  ä¸­å¤®å¤„ç†å™¨", "5.1 CPUçš„åŠŸèƒ½å’ŒåŸºæœ¬ç»“æ„", 25, ["co_ch5_s1"], ["CPUçš„åŠŸèƒ½", "CPUçš„åŸºæœ¬ç»“æ„", "CPUçš„å¯„å­˜å™¨"]],
    ["è®¡ç»„", "ç¬¬5ç«  ä¸­å¤®å¤„ç†å™¨", "5.2 æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹", 30, ["co_ch5_s2"], ["æŒ‡ä»¤å‘¨æœŸ", "æŒ‡ä»¤å‘¨æœŸçš„æ•°æ®æµ", "æŒ‡ä»¤æ‰§è¡Œæ–¹æ¡ˆ"]],
    ["è®¡ç»„", "ç¬¬5ç«  ä¸­å¤®å¤„ç†å™¨", "5.3 æ•°æ®é€šè·¯çš„åŠŸèƒ½å’ŒåŸºæœ¬ç»“æ„", 35, ["co_ch5_s3"], ["æ•°æ®é€šè·¯çš„åŠŸèƒ½", "æ•°æ®é€šè·¯çš„ç»„æˆ", "æ•°æ®é€šè·¯çš„åŸºæœ¬ç»“æ„", "æ•°æ®é€šè·¯çš„æ“ä½œä¸¾ä¾‹"]],
    ["è®¡ç»„", "ç¬¬5ç«  ä¸­å¤®å¤„ç†å™¨", "5.4 æ§åˆ¶å™¨çš„åŠŸèƒ½å’Œå·¥ä½œåŸç†", 35, ["co_ch5_s4"], ["æ§åˆ¶å™¨çš„ç»“æ„å’ŒåŠŸèƒ½", "ç¡¬å¸ƒçº¿æ§åˆ¶å™¨", "å¾®ç¨‹åºæ§åˆ¶å™¨"]],
    ["è®¡ç»„", "ç¬¬5ç«  ä¸­å¤®å¤„ç†å™¨", "5.5 å¼‚å¸¸å’Œä¸­æ–­æœºåˆ¶", 30, ["co_ch5_s5"], ["å¼‚å¸¸å’Œä¸­æ–­çš„åŸºæœ¬æ¦‚å¿µ", "å¼‚å¸¸å’Œä¸­æ–­çš„åˆ†ç±»", "å¼‚å¸¸å’Œä¸­æ–­å“åº”è¿‡ç¨‹"]],
    ["è®¡ç»„", "ç¬¬5ç«  ä¸­å¤®å¤„ç†å™¨", "5.6 æŒ‡ä»¤æµæ°´çº¿", 40, ["co_ch5_s6"], ["æŒ‡ä»¤æµæ°´çº¿çš„åŸºæœ¬æ¦‚å¿µ", "æµæ°´çº¿çš„åŸºæœ¬å®ç°", "æµæ°´çº¿çš„å†’é™©ä¸å¤„ç†", "æµæ°´çº¿çš„æ€§èƒ½æŒ‡æ ‡", "é«˜çº§æµæ°´çº¿æŠ€æœ¯"]],
    ["è®¡ç»„", "ç¬¬5ç«  ä¸­å¤®å¤„ç†å™¨", "5.7 å¤šå¤„ç†å™¨çš„åŸºæœ¬æ¦‚å¿µ", 25, ["co_ch5_s7"], ["SISDã€SIMDã€MIMD", "ç¡¬ä»¶å¤šçº¿ç¨‹", "å¤šæ ¸å¤„ç†å™¨", "å…±äº«å†…å­˜å¤šå¤„ç†å™¨"]],
    ["è®¡ç»„", "ç¬¬6ç«  æ€»çº¿", "6.1 æ€»çº¿æ¦‚è¿°", 30, ["co_ch6_s1"], ["æ€»çº¿åŸºæœ¬æ¦‚å¿µ", "æ€»çº¿çš„åˆ†ç±»", "ç³»ç»Ÿæ€»çº¿çš„ç»“æ„", "å¸¸è§çš„æ€»çº¿æ ‡å‡†", "æ€»çº¿çš„æ€§èƒ½æŒ‡æ ‡"]],
    ["è®¡ç»„", "ç¬¬6ç«  æ€»çº¿", "6.2 æ€»çº¿äº‹åŠ¡å’Œå®šæ—¶", 30, ["co_ch6_s2"], ["æ€»çº¿äº‹åŠ¡", "æ€»çº¿å®šæ—¶"]],
    ["è®¡ç»„", "ç¬¬7ç«  è¾“å…¥è¾“å‡ºç³»ç»Ÿ", "7.1 I/O ç³»ç»ŸåŸºæœ¬æ¦‚å¿µ", 25, ["co_ch7_s1"], ["è¾“å…¥/è¾“å‡ºç³»ç»Ÿ", "å¤–éƒ¨è®¾å¤‡", "I/O æ§åˆ¶æ–¹å¼"]],
    ["è®¡ç»„", "ç¬¬7ç«  è¾“å…¥è¾“å‡ºç³»ç»Ÿ", "7.2 I/Oæ¥å£", 30, ["co_ch7_s2"], ["I/Oæ¥å£çš„åŠŸèƒ½", "I/Oæ¥å£çš„åŸºæœ¬ç»“æ„", "I/Oæ¥å£çš„ç±»å‹", "I/Oç«¯å£åŠå…¶ç¼–å€"]],
    ["è®¡ç»„", "ç¬¬7ç«  è¾“å…¥è¾“å‡ºç³»ç»Ÿ", "7.3 I/Oæ–¹å¼", 35, ["co_ch7_s3"], ["ç¨‹åºæŸ¥è¯¢æ–¹å¼", "ç¨‹åºä¸­æ–­æ–¹å¼", "DMAæ–¹å¼"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°", "1.1 æ“ä½œç³»ç»Ÿçš„åŸºæœ¬æ¦‚å¿µ", 20, ["os_ch1_s1"], ["æ“ä½œç³»ç»Ÿçš„æ¦‚å¿µ", "æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½å’Œç›®æ ‡", "æ“ä½œç³»ç»Ÿçš„ç‰¹å¾"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°", "1.2 æ“ä½œç³»ç»Ÿå‘å±•å†ç¨‹", 25, ["os_ch1_s2"], ["æ‰‹å·¥æ“ä½œé˜¶æ®µ", "æ‰¹å¤„ç†é˜¶æ®µ", "åˆ†æ—¶æ“ä½œç³»ç»Ÿ", "å®æ—¶æ“ä½œç³»ç»Ÿ", "ç½‘ç»œå’Œåˆ†å¸ƒå¼ç³»ç»Ÿ", "ä¸ªäººè®¡ç®—æœºç³»ç»Ÿ"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°", "1.3 æ“ä½œç³»ç»Ÿçš„è¿è¡Œç¯å¢ƒ", 30, ["os_ch1_s3"], ["å¤„ç†å™¨è¿è¡Œæ¨¡å¼", "ä¸­æ–­å’Œå¼‚å¸¸çš„æ¦‚å¿µ", "ç³»ç»Ÿè°ƒç”¨"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°", "1.4 æ“ä½œç³»ç»Ÿç»“æ„", 20, ["os_ch1_s4"], ["æ“ä½œç³»ç»Ÿå†…æ ¸"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°", "1.5 æ“ä½œç³»ç»Ÿå¼•å¯¼", 20, ["os_ch1_s5"], ["å¼€æœºè¿‡ç¨‹"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°", "1.6 è™šæ‹Ÿæœº", 20, ["os_ch1_s6"], ["è™šæ‹Ÿæœºçš„åŸºæœ¬æ¦‚å¿µ"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬2ç«  è¿›ç¨‹ä¸çº¿ç¨‹", "2.1 è¿›ç¨‹ä¸çº¿ç¨‹", 35, ["os_ch2_s1"], ["è¿›ç¨‹çš„æ¦‚å¿µå’Œç‰¹å¾", "è¿›ç¨‹çš„ç»„æˆ", "è¿›ç¨‹çš„çŠ¶æ€ä¸è½¬æ¢", "è¿›ç¨‹æ§åˆ¶", "è¿›ç¨‹çš„é€šä¿¡", "çº¿ç¨‹å’Œå¤šçº¿ç¨‹æ¨¡å‹"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬2ç«  è¿›ç¨‹ä¸çº¿ç¨‹", "2.2 CPU è°ƒåº¦", 35, ["os_ch2_s2"], ["è°ƒåº¦çš„æ¦‚å¿µ", "è°ƒåº¦çš„å®ç°", "è°ƒåº¦çš„ç›®æ ‡", "è¿›ç¨‹åˆ‡æ¢", "CPU è°ƒåº¦ç®—æ³•", "å¤šå¤„ç†æœºè°ƒåº¦"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬2ç«  è¿›ç¨‹ä¸çº¿ç¨‹", "2.3 åŒæ­¥ä¸äº’æ–¥", 40, ["os_ch2_s3"], ["åŒæ­¥ä¸äº’æ–¥çš„åŸºæœ¬æ¦‚å¿µ", "å®ç°ä¸´ç•ŒåŒºäº’æ–¥çš„åŸºæœ¬æ–¹æ³•", "äº’æ–¥é”", "ä¿¡å·é‡", "ç»å…¸åŒæ­¥é—®é¢˜", "ç®¡ç¨‹"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬2ç«  è¿›ç¨‹ä¸çº¿ç¨‹", "2.4 æ­»é”", 35, ["os_ch2_s4"], ["æ­»é”çš„æ¦‚å¿µ", "æ­»é”é¢„é˜²", "æ­»é”é¿å…", "æ­»é”æ£€æµ‹å’Œè§£é™¤"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬3ç«  å†…å­˜ç®¡ç†", "3.1 å†…å­˜ç®¡ç†æ¦‚å¿µ", 40, ["os_ch3_s1"], ["å†…å­˜ç®¡ç†åŸºæœ¬åŸç†", "è¿ç»­åˆ†é…ç®¡ç†æ–¹å¼", "åŸºæœ¬åˆ†é¡µå­˜å‚¨ç®¡ç†", "åŸºæœ¬åˆ†æ®µå­˜å‚¨ç®¡ç†", "æ®µé¡µå¼å­˜å‚¨ç®¡ç†"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬3ç«  å†…å­˜ç®¡ç†", "3.2 è™šæ‹Ÿå†…å­˜ç®¡ç†", 40, ["os_ch3_s2"], ["è™šæ‹Ÿå†…å­˜åŸºæœ¬æ¦‚å¿µ", "è¯·æ±‚åˆ†é¡µç®¡ç†", "é¡µæ¡†åˆ†é…", "é¡µé¢ç½®æ¢ç®—æ³•", "æŠ–åŠ¨å’Œå·¥ä½œé›†", "å†…å­˜æ˜ å°„æ–‡ä»¶", "åœ°å€ç¿»è¯‘"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬4ç«  æ–‡ä»¶ç®¡ç†", "4.1 æ–‡ä»¶ç³»ç»ŸåŸºç¡€", 35, ["os_ch4_s1"], ["æ–‡ä»¶çš„åŸºæœ¬æ¦‚å¿µ", "æ–‡ä»¶æ§åˆ¶å—å’Œç´¢å¼•èŠ‚ç‚¹", "æ–‡ä»¶çš„æ“ä½œ", "æ–‡ä»¶çš„é€»è¾‘ç»“æ„", "æ–‡ä»¶çš„ç‰©ç†ç»“æ„", "æ–‡ä»¶ä¿æŠ¤"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬4ç«  æ–‡ä»¶ç®¡ç†", "4.2 ç›®å½•", 30, ["os_ch4_s2"], ["ç›®å½•çš„åŸºæœ¬æ¦‚å¿µ", "ç›®å½•çš„æ“ä½œ", "ç›®å½•ç»“æ„", "ç›®å½•å®ç°", "æ–‡ä»¶å…±äº«"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬4ç«  æ–‡ä»¶ç®¡ç†", "4.3 æ–‡ä»¶ç³»ç»Ÿ", 30, ["os_ch4_s3"], ["æ–‡ä»¶ç³»ç»Ÿç»“æ„", "æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€", "æ–‡ä»¶å­˜å‚¨ç©ºé—´ç®¡ç†", "è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ", "æ–‡ä»¶ç³»ç»ŸæŒ‚è½½"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬5ç«  è¾“å…¥è¾“å‡ºç®¡ç†", "5.1 I/O ç®¡ç†æ¦‚è¿°", 30, ["os_ch5_s1"], ["I/Oè®¾å¤‡", "I/Oæ§åˆ¶æ–¹å¼", "I/Oè½¯ä»¶å±‚æ¬¡ç»“æ„", "åº”ç”¨ç¨‹åºI/Oæ¥å£"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬5ç«  è¾“å…¥è¾“å‡ºç®¡ç†", "5.2 è®¾å¤‡ç‹¬ç«‹æ€§è½¯ä»¶", 35, ["os_ch5_s2"], ["è®¾å¤‡ç‹¬ç«‹æ€§", "é«˜é€Ÿç¼“å­˜ä¸ç¼“å†²åŒº", "è®¾å¤‡åˆ†é…ä¸å›æ”¶", "SPOOLingæŠ€æœ¯", "è®¾å¤‡é©±åŠ¨ç¨‹åºæ¥å£"]],
    ["æ“ä½œç³»ç»Ÿ", "ç¬¬5ç«  è¾“å…¥è¾“å‡ºç®¡ç†", "5.3 ç£ç›˜å’Œå›ºæ€ç¡¬ç›˜", 30, ["os_ch5_s3"], ["ç£ç›˜", "ç£ç›˜çš„ç®¡ç†", "ç£ç›˜è°ƒåº¦ç®—æ³•", "å›ºæ€ç¡¬ç›˜"]],
    ["è®¡ç½‘", "ç¬¬1ç«  è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„", "1.1 è®¡ç®—æœºç½‘ç»œæ¦‚è¿°", 30, ["cn_ch1_s1"], ["ç½‘ç»œçš„æ¦‚å¿µã€ç»„æˆã€åŠŸèƒ½", "äº¤æ¢æ–¹å¼(ç”µè·¯/æŠ¥æ–‡/åˆ†ç»„)", "ç½‘ç»œçš„åˆ†ç±»", "æ€§èƒ½æŒ‡æ ‡"]],
    ["è®¡ç½‘", "ç¬¬1ç«  è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„", "1.2 è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„ä¸å‚è€ƒæ¨¡å‹", 30, ["cn_ch1_s2"], ["ç½‘ç»œåˆ†å±‚ç»“æ„", "åè®®ã€æ¥å£ã€æœåŠ¡", "OSIå‚è€ƒæ¨¡å‹", "TCP/IPæ¨¡å‹"]],
    ["è®¡ç½‘", "ç¬¬2ç«  ç‰©ç†å±‚", "2.1 é€šä¿¡åŸºç¡€", 30, ["cn_ch2_s1"], ["åŸºæœ¬æ¦‚å¿µ(ä¿¡é“/ç å…ƒ/æ³¢ç‰¹/é€Ÿç‡)", "ä¿¡é“çš„æé™å®¹é‡(å¥ˆæ°/é¦™å†œ)", "ç¼–ç ä¸è°ƒåˆ¶"]],
    ["è®¡ç½‘", "ç¬¬2ç«  ç‰©ç†å±‚", "2.2 ä¼ è¾“ä»‹è´¨", 25, ["cn_ch2_s2"], ["åŒç»çº¿ã€åŒè½´ç”µç¼†ã€å…‰çº¤", "æ— çº¿ä¼ è¾“ä»‹è´¨", "ç‰©ç†å±‚æ¥å£ç‰¹æ€§"]],
    ["è®¡ç½‘", "ç¬¬2ç«  ç‰©ç†å±‚", "2.3 ç‰©ç†å±‚è®¾å¤‡", 20, ["cn_ch2_s3"], ["ä¸­ç»§å™¨", "é›†çº¿å™¨"]],
    ["è®¡ç½‘", "ç¬¬3ç«  æ•°æ®é“¾è·¯å±‚", "3.1 æ•°æ®é“¾è·¯å±‚çš„åŠŸèƒ½", 25, ["cn_ch3_s1"], ["é“¾è·¯å±‚åœ°ä½", "é“¾è·¯ç®¡ç†", "å°è£…æˆå¸§ä¸é€æ˜ä¼ è¾“", "æµé‡æ§åˆ¶", "å·®é”™æ£€æµ‹"]],
    ["è®¡ç½‘", "ç¬¬3ç«  æ•°æ®é“¾è·¯å±‚", "3.2 ç»„å¸§", 25, ["cn_ch3_s2"], ["å­—ç¬¦è®¡æ•°æ³•", "å­—èŠ‚å¡«å……æ³•", "é›¶æ¯”ç‰¹å¡«å……æ³•", "è¿è§„ç¼–ç æ³•"]],
    ["è®¡ç½‘", "ç¬¬3ç«  æ•°æ®é“¾è·¯å±‚", "3.3 å·®é”™æ§åˆ¶", 30, ["cn_ch3_s3"], ["æ£€é”™ç¼–ç (å¥‡å¶/CRC)", "çº é”™ç¼–ç (æµ·æ˜ç )"]],
    ["è®¡ç½‘", "ç¬¬3ç«  æ•°æ®é“¾è·¯å±‚", "3.4 æµé‡æ§åˆ¶ä¸å¯é ä¼ è¾“æœºåˆ¶", 35, ["cn_ch3_s4"], ["æµé‡æ§åˆ¶ä¸æ»‘åŠ¨çª—å£", "å¯é ä¼ è¾“(åœæ­¢-ç­‰å¾…/GBN/SR)"]],
    ["è®¡ç½‘", "ç¬¬3ç«  æ•°æ®é“¾è·¯å±‚", "3.5 ä»‹è´¨è®¿é—®æ§åˆ¶", 35, ["cn_ch3_s5"], ["ä¿¡é“åˆ’åˆ†(FDMA/TDMA/WDMA/CDMA)", "éšæœºè®¿é—®(ALOHA/CSMA)", "è½®è¯¢è®¿é—®(ä»¤ç‰Œä¼ é€’)"]],
    ["è®¡ç½‘", "ç¬¬3ç«  æ•°æ®é“¾è·¯å±‚", "3.6 å±€åŸŸç½‘", 30, ["cn_ch3_s6"], ["å±€åŸŸç½‘æ¦‚å¿µä¸ä½“ç³»ç»“æ„", "ä»¥å¤ªç½‘ä¸IEEE 802.3", "IEEE 802.11æ— çº¿å±€åŸŸç½‘", "VLAN"]],
    ["è®¡ç½‘", "ç¬¬3ç«  æ•°æ®é“¾è·¯å±‚", "3.7 å¹¿åŸŸç½‘", 25, ["cn_ch3_s7"], ["å¹¿åŸŸç½‘åŸºæœ¬æ¦‚å¿µ", "ç‚¹å¯¹ç‚¹åè®®(PPP)"]],
    ["è®¡ç½‘", "ç¬¬3ç«  æ•°æ®é“¾è·¯å±‚", "3.8 æ•°æ®é“¾è·¯å±‚è®¾å¤‡", 25, ["cn_ch3_s8"], ["ç½‘æ¡¥", "ä»¥å¤ªç½‘äº¤æ¢æœº"]],
    ["è®¡ç½‘", "ç¬¬4ç«  ç½‘ç»œå±‚", "4.1 ç½‘ç»œå±‚çš„åŠŸèƒ½", 30, ["cn_ch4_s1"], ["å¼‚æ„ç½‘ç»œäº’è¿", "è·¯ç”±ä¸è½¬å‘", "ç½‘ç»œå±‚æœåŠ¡(è™šç”µè·¯/æ•°æ®æŠ¥)", "SDN", "æ‹¥å¡æ§åˆ¶"]],
    ["è®¡ç½‘", "ç¬¬4ç«  ç½‘ç»œå±‚", "4.2 IPv4", 40, ["cn_ch4_s2"], ["IPv4åˆ†ç»„", "IPv4åœ°å€ä¸NAT", "åˆ’åˆ†å­ç½‘ä¸è·¯ç”±èšåˆ(CIDR)", "ARP", "DHCP", "ICMP"]],
    ["è®¡ç½‘", "ç¬¬4ç«  ç½‘ç»œå±‚", "4.3 IPv6", 30, ["cn_ch4_s3"], ["IPv6ç‰¹ç‚¹", "IPv6æ•°æ®æŠ¥", "IPv6åœ°å€", "IPv4å‘IPv6è¿‡æ¸¡"]],
    ["è®¡ç½‘", "ç¬¬4ç«  ç½‘ç»œå±‚", "4.4 è·¯ç”±ç®—æ³•ä¸è·¯ç”±åè®®", 40, ["cn_ch4_s4"], ["è·¯ç”±ç®—æ³•(é™æ€/åŠ¨æ€)", "åˆ†å±‚æ¬¡è·¯ç”±(RIP/OSPF/BGP)"]],
    ["è®¡ç½‘", "ç¬¬4ç«  ç½‘ç»œå±‚", "4.5 IPå¤šæ’­", 25, ["cn_ch4_s5"], ["å¤šæ’­æ¦‚å¿µ", "IPå¤šæ’­åœ°å€", "IGMPä¸å¤šæ’­è·¯ç”±åè®®"]],
    ["è®¡ç½‘", "ç¬¬4ç«  ç½‘ç»œå±‚", "4.6 ç§»åŠ¨IP", 25, ["cn_ch4_s6"], ["ç§»åŠ¨IPæ¦‚å¿µ", "ç§»åŠ¨IPé€šä¿¡è¿‡ç¨‹"]],
    ["è®¡ç½‘", "ç¬¬4ç«  ç½‘ç»œå±‚", "4.7 ç½‘ç»œå±‚è®¾å¤‡", 25, ["cn_ch4_s7"], ["å†²çªåŸŸå’Œå¹¿æ’­åŸŸ", "è·¯ç”±å™¨"]],
    ["è®¡ç½‘", "ç¬¬5ç«  ä¼ è¾“å±‚", "5.1 ä¼ è¾“å±‚æä¾›çš„æœåŠ¡", 25, ["cn_ch5_s1"], ["ä¼ è¾“å±‚åŠŸèƒ½", "å¯»å€ä¸ç«¯å£", "æ— è¿æ¥ä¸é¢å‘è¿æ¥æœåŠ¡"]],
    ["è®¡ç½‘", "ç¬¬5ç«  ä¼ è¾“å±‚", "5.2 UDP", 25, ["cn_ch5_s2"], ["UDPæ•°æ®æŠ¥", "UDPæ£€éªŒ"]],
    ["è®¡ç½‘", "ç¬¬5ç«  ä¼ è¾“å±‚", "5.3 TCP", 40, ["cn_ch5_s3"], ["TCPç‰¹ç‚¹", "TCPæŠ¥æ–‡æ®µ", "TCPè¿æ¥ç®¡ç†(ä¸‰æ¬¡æ¡æ‰‹/å››æ¬¡æŒ¥æ‰‹)", "TCPå¯é ä¼ è¾“", "TCPæµé‡æ§åˆ¶", "TCPæ‹¥å¡æ§åˆ¶"]],
    ["è®¡ç½‘", "ç¬¬6ç«  åº”ç”¨å±‚", "6.1 ç½‘ç»œåº”ç”¨æ¨¡å‹", 20, ["cn_ch6_s1"], ["å®¢æˆ·/æœåŠ¡å™¨æ¨¡å‹", "P2Pæ¨¡å‹"]],
    ["è®¡ç½‘", "ç¬¬6ç«  åº”ç”¨å±‚", "6.2 åŸŸåç³»ç»Ÿ(DNS)", 30, ["cn_ch6_s2"], ["å±‚æ¬¡åŸŸåç©ºé—´", "åŸŸåæœåŠ¡å™¨", "åŸŸåè§£æè¿‡ç¨‹"]],
    ["è®¡ç½‘", "ç¬¬6ç«  åº”ç”¨å±‚", "6.3 æ–‡ä»¶ä¼ è¾“åè®®(FTP)", 25, ["cn_ch6_s3"], ["FTPå·¥ä½œåŸç†", "æ§åˆ¶è¿æ¥ä¸æ•°æ®è¿æ¥"]],
    ["è®¡ç½‘", "ç¬¬6ç«  åº”ç”¨å±‚", "6.4 ç”µå­é‚®ä»¶", 25, ["cn_ch6_s4"], ["ç”µå­é‚®ä»¶ç³»ç»Ÿç»„æˆ", "é‚®ä»¶æ ¼å¼ä¸MIME", "SMTPå’ŒPOP3"]],
    ["è®¡ç½‘", "ç¬¬6ç«  åº”ç”¨å±‚", "6.5 ä¸‡ç»´ç½‘(WWW)", 30, ["cn_ch6_s5"], ["WWWæ¦‚å¿µä¸ç»„æˆ", "HTTPåè®®"]],
  ];

  const MAX_WEIGHT_FOR_NEW = 50;
  const CHAPTER_MAX_DURATIONS = {
    "æ•°æ®ç»“æ„ - ç¬¬1ç«  ç»ªè®º": 50, "æ•°æ®ç»“æ„ - ç¬¬2ç«  çº¿æ€§è¡¨": 85, "æ•°æ®ç»“æ„ - ç¬¬3ç«  æ ˆã€é˜Ÿåˆ—å’Œæ•°ç»„": 130, "æ•°æ®ç»“æ„ - ç¬¬4ç«  ä¸²": 65, "æ•°æ®ç»“æ„ - ç¬¬5ç«  æ ‘ä¸äºŒå‰æ ‘": 145, "æ•°æ®ç»“æ„ - ç¬¬6ç«  å›¾": 120, "æ•°æ®ç»“æ„ - ç¬¬7ç«  æŸ¥æ‰¾": 155, "æ•°æ®ç»“æ„ - ç¬¬8ç«  æ’åº": 190,
    "è®¡ç»„ - ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°": 75, "è®¡ç»„ - ç¬¬2ç«  æ•°æ®çš„è¡¨ç¤ºå’Œè¿ç®—": 100, "è®¡ç»„ - ç¬¬3ç«  å­˜å‚¨ç³»ç»Ÿ": 180, "è®¡ç»„ - ç¬¬4ç«  æŒ‡ä»¤ç³»ç»Ÿ": 120, "è®¡ç»„ - ç¬¬5ç«  ä¸­å¤®å¤„ç†å™¨": 185, "è®¡ç»„ - ç¬¬6ç«  æ€»çº¿": 60, "è®¡ç»„ - ç¬¬7ç«  è¾“å…¥è¾“å‡ºç³»ç»Ÿ": 90,
    "æ“ä½œç³»ç»Ÿ - ç¬¬1ç«  è®¡ç®—æœºç³»ç»Ÿæ¦‚è¿°": 135, "æ“ä½œç³»ç»Ÿ - ç¬¬2ç«  è¿›ç¨‹ä¸çº¿ç¨‹": 145, "æ“ä½œç³»ç»Ÿ - ç¬¬3ç«  å†…å­˜ç®¡ç†": 80, "æ“ä½œç³»ç»Ÿ - ç¬¬4ç«  æ–‡ä»¶ç®¡ç†": 95, "æ“ä½œç³»ç»Ÿ - ç¬¬5ç«  è¾“å…¥è¾“å‡ºç®¡ç†": 95,
    "è®¡ç½‘ - ç¬¬1ç«  è®¡ç®—æœºç½‘ç»œä½“ç³»ç»“æ„": 60, "è®¡ç½‘ - ç¬¬2ç«  ç‰©ç†å±‚": 75, "è®¡ç½‘ - ç¬¬3ç«  æ•°æ®é“¾è·¯å±‚": 220, "è®¡ç½‘ - ç¬¬4ç«  ç½‘ç»œå±‚": 215, "è®¡ç½‘ - ç¬¬5ç«  ä¼ è¾“å±‚": 90, "è®¡ç½‘ - ç¬¬6ç«  åº”ç”¨å±‚": 130
  };

  // --- æ ¸å¿ƒé€»è¾‘åŒº ---
  let previousView = 'dashboard-container';
  let currentPlanDate = null;
  const getTodayDateString = () => new Date().toISOString().slice(0, 10);
  const storage = {
    get: (key, defaultValue = null) => { try { return JSON.parse(localStorage.getItem(key)) || defaultValue; } catch { return defaultValue; } },
    set: (key, value) => localStorage.setItem(key, JSON.stringify(value)),
  };

  function getWeightedSyllabus(history, today, subjectWeights) {
    const oneDay = 1000 * 60 * 60 * 24;
    return SYLLABUS.map(item => {
      const sectionName = item[2];
      const subjectName = item[0];
      const historyItem = history[sectionName];
      let forgettingWeight = historyItem ? (Math.log(Math.round((today - new Date(historyItem.lastReviewed)) / oneDay) + 1) * 5 + 1) : MAX_WEIGHT_FOR_NEW;
      let finalWeight = forgettingWeight * (subjectWeights[subjectName] || 3);
      return { data: item, weight: finalWeight };
    });
  }

  function generateUniqueDailyPlan(max_duration, subjectWeights, efficiencyMultiplier = 1.0) {
    const today = new Date();
    const todayStr = getTodayDateString();
    const history = storage.get('reviewHistory', {});
    const weightedSyllabus = getWeightedSyllabus(history, today, subjectWeights);

    let review_plan = [];
    let total_duration = 0;
    const chapterDurations = {};
    const subjectsInPlan = new Set();

    const avgItemDuration = 30 * efficiencyMultiplier;
    const maxChapters = Math.max(3, Math.floor(max_duration / avgItemDuration));

    let remainingItems = [...weightedSyllabus];

    function pickWeightedRandom(items) {
      if (items.length === 0) return null;
      const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
      let random = Math.random() * totalWeight;
      for (let i = 0; i < items.length; i++) {
        random -= items[i].weight;
        if (random <= 0) {
          return items[i];
        }
      }
      return items[items.length - 1];
    }

    while (total_duration < max_duration && remainingItems.length > 0) {
      let pickedItem = null;
      let pickedItemIndex = -1;
      let attempts = 0;
      const maxAttempts = remainingItems.length * 2;

      while (attempts < maxAttempts) {
        attempts++;
        const candidate = pickWeightedRandom(remainingItems);
        if (!candidate) break;

        const itemArray = candidate.data;
        const chapterName = itemArray[0] + ' - ' + itemArray[1];
        const itemDuration = Math.round(itemArray[3] * efficiencyMultiplier);
        const currentChapterDuration = chapterDurations[chapterName] || 0;
        const currentChapterCount = Object.keys(chapterDurations).length;

        if (review_plan.length > 0 && total_duration + itemDuration > max_duration + 15) {
          continue;
        }
        if (max_duration <= 180 && currentChapterCount >= maxChapters && !chapterDurations[chapterName]) {
          continue;
        }
        const chapterMaxDuration = (CHAPTER_MAX_DURATIONS[chapterName] || 120) * efficiencyMultiplier;
        if (currentChapterDuration + itemDuration > chapterMaxDuration) {
          continue;
        }

        if (subjectsInPlan.size < 2 && subjectsInPlan.size > 0 && subjectsInPlan.has(itemArray[0]) && Math.random() < 0.5) {
          continue;
        }
        if (subjectsInPlan.size < 3 && subjectsInPlan.size > 0 && subjectsInPlan.has(itemArray[0]) && Math.random() < 0.25) {
          continue;
        }

        pickedItem = candidate;
        pickedItemIndex = remainingItems.findIndex(item => item === pickedItem);
        break;
      }

      if (pickedItem) {
        const itemArray = pickedItem.data;
        const itemDuration = Math.round(itemArray[3] * efficiencyMultiplier);
        const chapterName = itemArray[0] + ' - ' + itemArray[1];

        review_plan.push({
          subject: itemArray[0], chapter: itemArray[1], section: itemArray[2],
          duration: itemDuration, tags: itemArray[4], notes: [], completed: false
        });
        total_duration += itemDuration;
        chapterDurations[chapterName] = (chapterDurations[chapterName] || 0) + itemDuration;
        subjectsInPlan.add(itemArray[0]);

        remainingItems.splice(pickedItemIndex, 1);
      } else {
        break;
      }
    }

    const planData = { plan: review_plan, duration: total_duration, generatedFor: max_duration, isFinished: false };
    storage.set('plan_' + todayStr, planData);
    return planData;
  }


  // --- æ ¸å¿ƒè§†å›¾æ¸²æŸ“ä¸é€»è¾‘ ---

  function renderPlanView(dateStr) {
    currentPlanDate = dateStr;
    const planData = storage.get('plan_' + dateStr);
    if (!planData || !planData.plan) return;

    const { plan, duration } = planData;
    const isToday = dateStr === getTodayDateString();
    const container = document.getElementById('plan-container');

    let headerHTML =
            '<div class="flex flex-col sm:flex-row justify-between items-center mb-8">' +
            '<div>' +
            `<h2 class="text-3xl font-bold text-white mb-2">${isToday ? 'ä»Šæ—¥' : dateStr} å¤ä¹ æ¸…å•</h2>` +
            `<p class="text-slate-400">é¢„è®¡æ€»æ—¶é•¿: ${Math.floor(duration / 60)} å°æ—¶ ${duration % 60} åˆ†é’Ÿ</p>` +
            '</div>' +
            '<div class="flex space-x-2 mt-4 sm:mt-0">';

    headerHTML += '<button id="backToDashboardBtn" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-slate-500 transition-colors">è¿”å›ä¸»é¡µ</button>';
    if (isToday && !planData.isFinished) {
      headerHTML += '<button id="resetDurationBtn" class="bg-amber-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-amber-500 transition-colors">é‡è®¾æ—¶é•¿</button>';
    }
    headerHTML +=
            '<button id="showStatsBtn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-sky-500 transition-colors">å¤ä¹ ç»Ÿè®¡</button>' +
            '<button id="exportBtn" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-emerald-500 transition-colors">å¯¼å‡ºCSV</button>' +
            '</div>' +
            '</div>' +
            '<div id="plan-list" class="space-y-4"></div>';

    if(isToday && !planData.isFinished) {
      headerHTML += '<div class="mt-8 text-center"><button id="finishDayBtn" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-purple-500 transition-colors text-lg">âœ¨ ç»“æŸä»Šæ—¥å­¦ä¹ å¹¶æ€»ç»“</button></div>';
    }
    container.innerHTML = headerHTML;

    const list = document.getElementById('plan-list');
    plan.forEach((item, index) => {
      const isCompleted = item.completed;
      const notesContainerId = `notes-container-${dateStr.replace(/-/g, '')}-${index}`;

      const aiToolsHTML =
              `<div class="ai-tools-section flex-shrink-0 flex items-center space-x-2">` +
              `<button class="ai-btn flex items-center space-x-1 text-xs bg-sky-800/80 hover:bg-sky-700/80 text-sky-300 font-semibold py-1 px-2 rounded-md transition-colors" data-type="explain" data-topic="${item.section}" title="æ·±å…¥è§£æ">` +
              `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.375 3.375 0 0014 18.442V19.5a.5.5 0 01-.5.5h-3a.5.5 0 01-.5-.5v-1.058a3.375 3.375 0 00-.913-2.312l-.547-.547z" /></svg>` +
              `<span>è§£æ</span>` +
              `</button>` +
              `<button class="ai-btn flex items-center space-x-1 text-xs bg-emerald-800/80 hover:bg-emerald-700/80 text-emerald-300 font-semibold py-1 px-2 rounded-md transition-colors" data-type="question" data-topic="${item.section}" data-plan-index="${index}" title="ç”Ÿæˆç»ƒä¹ é¢˜">` +
              `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>` +
              `<span>å‡ºé¢˜</span>` +
              `</button>` +
              `</div>`;

      const planItemHTML =
              `<div class="list-item-animation glass-card p-4 flex flex-col" style="animation-delay: ${index * 80}ms;" data-plan-index="${index}">` +
              `<div class="flex items-start space-x-4">` +
              `<div class="task-knob mt-1 flex-shrink-0 ${isCompleted ? 'completed' : ''}" data-plan-index="${index}">` +
              `<span class="knob-number">${index + 1}</span>` +
              '<span class="knob-checkmark">âœ”</span>' +
              '</div>' +
              `<div class="flex-grow cursor-pointer" data-plan-index="${index}">` +
              '<div class="flex justify-between items-baseline">' +
              `<p class="font-bold text-lg text-white">${item.section}</p>` +
              `<span class="text-sm text-slate-400">${item.duration}åˆ†é’Ÿ</span>` +
              '</div>' +
              `<p class="plan-text text-slate-400 text-sm ${isCompleted ? 'completed' : ''}">${item.subject} - ${item.chapter}</p>` +
              '</div>' +
              `</div>` +
              `<div class="border-t border-slate-700/50 pl-12 pt-3 mt-3 flex justify-between items-center">`+
              `<div id="${notesContainerId}" class="notes-section flex flex-wrap gap-2 items-center">` +
              `</div>` +
              aiToolsHTML +
              `</div>` +
              `</div>`;
      list.insertAdjacentHTML('beforeend', planItemHTML);
      const notesContainer = document.getElementById(notesContainerId);
      if(notesContainer) updateNotesUI(notesContainer, dateStr, index);
    });


    switchView('plan-container');
    attachPlanEventListeners(dateStr);
  }

  function updateNotesUI(container, dateStr, planIndex) {
    if(!container) return;
    container.innerHTML = '';
    const planData = storage.get('plan_' + dateStr);
    const item = planData.plan[planIndex];
    const notes = item.notes || [];

    notes.forEach((noteContent, noteIndex) => {
      const noteBtn = document.createElement('button');
      noteBtn.className = 'note-btn bg-indigo-800/80 text-xs text-indigo-200 py-1 px-3 rounded-full hover:bg-indigo-700/80 transition-colors';
      noteBtn.textContent = `ç¬”è®° ${noteIndex + 1}`;
      noteBtn.onclick = () => showNoteModal(dateStr, planIndex, noteIndex);
      container.appendChild(noteBtn);
    });

    const addNoteBtn = document.createElement('button');
    addNoteBtn.className = 'add-note-btn bg-slate-700 text-xs text-slate-300 py-1 px-3 rounded-full hover:bg-slate-600 transition-colors';
    addNoteBtn.innerHTML = '+ æ·»åŠ ç¬”è®°';
    addNoteBtn.onclick = () => showNoteModal(dateStr, planIndex, -1);
    container.appendChild(addNoteBtn);
  }

  function displayDashboard() {
    const container = document.getElementById('dashboard-container');
    const history = storage.get('reviewHistory', {});
    const today = new Date();
    const oneDay = 1000 * 60 * 60 * 24;

    // Greeting
    const hours = today.getHours();
    let greeting = '';
    if (hours < 6) { greeting = 'å‡Œæ™¨äº†ï¼Œæ³¨æ„ä¼‘æ¯å“¦'; }
    else if (hours < 12) { greeting = 'ä¸Šåˆå¥½ï¼Œæ–°çš„ä¸€å¤©å¼€å§‹äº†'; }
    else if (hours < 14) { greeting = 'ä¸­åˆå¥½ï¼Œç¨ä½œä¼‘æ¯å§'; }
    else if (hours < 18) { greeting = 'ä¸‹åˆå¥½ï¼Œç»§ç»­åŠªåŠ›'; }
    else { greeting = 'æ™šä¸Šå¥½ï¼Œä»Šå¤©è¿‡å¾—å……å®å—'; }

    let totalMemoryStrength = 0;
    SYLLABUS.forEach(s => {
      const historyItem = history[s[2]];
      const strength = historyItem ? Math.max(0.1, Math.exp(-Math.round((today - new Date(historyItem.lastReviewed)) / oneDay) / 14)) : 0.1;
      totalMemoryStrength += strength;
    });
    const overallMastery = (totalMemoryStrength / SYLLABUS.length * 100).toFixed(1);

    const todayStr = getTodayDateString();
    const todayPlan = storage.get('plan_' + todayStr);
    let ctaButtonHTML = '';
    if (!todayPlan) {
      ctaButtonHTML = '<button id="main-cta-btn" data-action="generate" class="main-cta-btn text-white font-bold py-4 px-8 w-full rounded-full"><span class="text-xl">ğŸš€ å¼€å¯ä»Šæ—¥å¤ä¹ </span></button>';
    } else if (!todayPlan.isFinished) {
      ctaButtonHTML = '<button id="main-cta-btn" data-action="continue" class="main-cta-btn text-white font-bold py-4 px-8 w-full rounded-full"><span class="text-xl">ğŸ’ª ç»§ç»­ä»Šæ—¥å­¦ä¹ </span></button>';
    } else {
      ctaButtonHTML = '<button id="main-cta-btn" data-action="summary" class="main-cta-btn text-white font-bold py-4 px-8 w-full rounded-full"><span class="text-xl">ğŸ“Š æŸ¥çœ‹ä»Šæ—¥æ€»ç»“</span></button>';
    }

    container.innerHTML = `
        <div class="flex flex-col items-center justify-center text-center">
            <p class="text-slate-400 mb-2">${greeting}</p>
            <h2 class="text-4xl md:text-5xl font-bold text-white mb-8 tracking-wide">å‡†å¤‡å¥½å¼€å§‹å­¦ä¹ äº†å—ï¼Ÿ</h2>

            <div class="mb-12 w-full max-w-md">
                ${ctaButtonHTML}
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 w-full">
                <div class="glass-card p-6 list-item-animation" style="animation-delay: 100ms;">
                    <div class="flex justify-center items-center mb-3 h-10 w-10 rounded-full bg-green-500/20 mx-auto">
                        <svg class="h-6 w-6 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5V6m0 12v4.5m4.5-16.5l-3.182 3.182m-8.636 8.636L6 18.5m12-3.5l3.182 3.182M1.5 12h4.5m12 0h4.5M6 5.5l-3.182-3.182M18 5.5l3.182-3.182" /></svg>
                    </div>
                    <p class="text-sm font-medium text-slate-400">æ€»æŒæ¡åº¦</p>
                    <p class="text-4xl font-bold text-green-400 mt-1">${overallMastery}%</p>
                </div>

                <div id="goToStatsBtn" class="glass-card p-6 list-item-animation hover:!bg-sky-600/30 cursor-pointer" style="animation-delay: 200ms;">
                    <div class="flex justify-center items-center mb-3 h-10 w-10 rounded-full bg-sky-500/20 mx-auto">
                         <svg class="h-6 w-6 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
                    </div>
                     <p class="font-bold text-lg text-sky-400">å­¦ä¹ ç»Ÿè®¡ &rarr;</p>
                     <p class="text-xs text-slate-500 mt-1">æŸ¥çœ‹é—å¿˜æ›²çº¿ä¸è–„å¼±ç‚¹</p>
                </div>

                <div id="goToQuestionHistoryBtn" class="glass-card p-6 list-item-animation hover:!bg-purple-600/30 cursor-pointer" style="animation-delay: 300ms;">
                     <div class="flex justify-center items-center mb-3 h-10 w-10 rounded-full bg-purple-500/20 mx-auto">
                        <svg class="h-6 w-6 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.455-2.456L12.75 18l1.178-.398a3.375 3.375 0 002.455-2.456L16.5 14.25l.398 1.178a3.375 3.375 0 002.456 2.456l1.178.398-1.178.398a3.375 3.375 0 00-2.456 2.456z" /></svg>
                    </div>
                    <p class="font-bold text-lg text-purple-400">AI æ™ºèƒ½é¢˜åº“ &rarr;</p>
                    <p class="text-xs text-slate-500 mt-1">å·©å›ºçŸ¥è¯†ï¼ŒæŸ¥æ¼è¡¥ç¼º</p>
                </div>
            </div>

            <button id="goToTimelineBtn" class="border border-slate-700 text-slate-400 font-medium py-3 px-6 rounded-lg hover:bg-slate-800/80 hover:text-white hover:border-slate-600 transition-colors">
                æŸ¥çœ‹å®Œæ•´å¤ä¹ å†å²
            </button>
        </div>
    `;

    switchView('dashboard-container');

    document.getElementById('main-cta-btn').addEventListener('click', (e) => {
      const action = e.currentTarget.dataset.action;
      if (action === 'generate') {
        previousView = 'dashboard-container';
        displaySettings();
      }
      else if (action === 'continue') {
        previousView = 'dashboard-container';
        renderPlanView(todayStr);
      }
      else if (action === 'summary') {
        previousView = 'dashboard-container';
        displaySummaryView(todayStr);
      }
    });

    const statsBtn = document.getElementById('goToStatsBtn');
    if(statsBtn) {
      statsBtn.addEventListener('click', () => {
        previousView = 'dashboard-container';
        displayStatisticsMain();
      });
    }

    const questionHistoryBtn = document.getElementById('goToQuestionHistoryBtn');
    if(questionHistoryBtn) {
      questionHistoryBtn.addEventListener('click', () => {
        previousView = 'dashboard-container';
        displayQuestionHistory();
      });
    }

    const timelineBtn = document.getElementById('goToTimelineBtn');
    if(timelineBtn) {
      timelineBtn.addEventListener('click', () => {
        previousView = 'dashboard-container';
        displayTimelinePage();
      });
    }
  }

  function displaySummaryView(dateStr) {
    const container = document.getElementById('summary-container');
    const planData = storage.get('plan_' + dateStr, { plan: [], duration: 0 });
    const plan = planData.plan || [];

    const completedCount = plan.filter(p => p.completed).length;
    const completionRate = plan.length > 0 ? (completedCount / plan.length * 100).toFixed(0) : 0;
    const reviewedChapters = [...new Set(plan.filter(p => p.completed).map(p => p.chapter))];
    const totalDuration = plan.reduce((sum, item) => sum + item.duration, 0);
    const notesCount = plan.reduce((sum, item) => sum + (item.notes ? item.notes.length : 0), 0);
    const aiQuestions = storage.get('aiQuestionHistory', []).filter(q => q.date === dateStr).length;

    container.innerHTML =
            '<h2 class="text-4xl md:text-5xl font-bold text-white mb-4 text-center">ä»Šæ—¥å­¦ä¹ æ€»ç»“</h2>' +
            `<p class="text-lg text-slate-400 mb-8 text-center">${dateStr} - åˆæ˜¯æ”¶è·æ»¡æ»¡çš„ä¸€å¤©ï¼</p>` +

            '<div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">' +
            '<div class="glass-card p-4 rounded-lg text-center"><p class="text-sm text-slate-400">è®¡åˆ’å®Œæˆåº¦</p><p class="text-3xl font-bold text-green-400">' + completionRate + '%</p></div>' +
            '<div class="glass-card p-4 rounded-lg text-center"><p class="text-sm text-slate-400">æ€»å¤ä¹ æ—¶é•¿</p><p class="text-3xl font-bold text-sky-400">' + (totalDuration/60).toFixed(1) + 'å°æ—¶</p></div>' +
            '<div class="glass-card p-4 rounded-lg text-center"><p class="text-sm text-slate-400">å¤ä¹ ç« èŠ‚æ•°</p><p class="text-3xl font-bold text-amber-400">' + reviewedChapters.length + '</p></div>' +
            '<div class="glass-card p-4 rounded-lg text-center col-span-2 md:col-span-1"><p class="text-sm text-slate-400">ç”ŸæˆAIé¢˜ç›®</p><p class="text-3xl font-bold text-purple-400">' + aiQuestions + 'é“</p></div>' +
            '<div class="glass-card p-4 rounded-lg text-center"><p class="text-sm text-slate-400">æ’°å†™ç¬”è®°</p><p class="text-3xl font-bold text-indigo-400">' + notesCount + 'æ¡</p></div>' +
            '<div class="glass-card p-4 rounded-lg text-center flex items-center justify-center hover:!bg-rose-600/30"><button id="aiSmartSummaryBtn" class="text-rose-400 font-bold text-lg hover:text-rose-300 transition-colors">AIæ™ºèƒ½å°ç»“ &rarr;</button></div>' +
            '</div>' +

            '<div class="glass-card p-6 mt-6">' +
            '<h3 class="font-bold text-white mb-4">ä»Šæ—¥å®Œæˆç« èŠ‚</h3>' +
            '<div class="flex flex-wrap gap-2">' +
            (reviewedChapters.length > 0 ? reviewedChapters.map(c => `<span class="bg-slate-700 text-xs font-semibold px-2.5 py-1 rounded-full">${c}</span>`).join('') : '<p class="text-slate-500 text-sm">ä»Šå¤©æ²¡æœ‰å®Œæˆä»»ä½•ç« èŠ‚å“¦ã€‚</p>') +
            '</div>' +
            '</div>' +

            '<div class="mt-8 flex justify-center">' +
            '<button id="backToDashboardFromSummary" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-indigo-500 transition-all">è¿”å›ä»ªè¡¨ç›˜</button>' +
            '</div>';

    switchView('summary-container');
    document.getElementById('backToDashboardFromSummary').addEventListener('click', ()=>{
      previousView = 'summary-container';
      displayDashboard();
    });
    document.getElementById('aiSmartSummaryBtn').addEventListener('click', () => handleSmartSummary(dateStr));
  }

  function displaySettings() {
    const container = document.getElementById('settings-container');
    container.innerHTML =
            '<h2 class="text-4xl md:text-5xl font-bold text-white mb-4 text-center">å¤ä¹ è®¾ç½®</h2>' +
            '<p class="text-lg text-slate-400 mb-8 text-center">è‡ªå®šä¹‰æ—¶é•¿ä¸ç§‘ç›®é‡ç‚¹ï¼Œç”Ÿæˆä½ çš„ä¸“å±å­¦ä¹ ä»»åŠ¡ã€‚</p>' +
            '<div class="w-full max-w-lg mx-auto glass-card p-8 space-y-8">' +
            '<div>' +
            '<label for="duration-slider" class="block text-xl font-bold text-white mb-3">å¤ä¹ æ€»æ—¶é•¿: <span id="duration-display" class="text-indigo-300">2.0 å°æ—¶</span></label>' +
            '<input type="range" id="duration-slider" min="30" max="480" step="15" value="120" class="w-full">' +
            '</div>' +
            '<div>' +
            '<h3 class="text-xl font-bold text-white mb-4">å¤ä¹ æ¨¡å¼</h3>' +
            '<div id="efficiency-group" class="weight-btn-group bg-slate-900/80 rounded-full p-1 flex">' +
            '<button data-multiplier="0.7" class="w-full text-center rounded-full py-2 text-sm text-slate-300 transition-all">é«˜æ•ˆåˆ·é¢˜</button>' +
            '<button data-multiplier="1.0" class="w-full text-center rounded-full py-2 text-sm text-slate-300 transition-all active">å¸¸è§„å¤ä¹ </button>' +
            '<button data-multiplier="1.3" class="w-full text-center rounded-full py-2 text-sm text-slate-300 transition-all">æ·±å…¥å­¦ä¹ </button>' +
            '</div>' +
            '</div>' +
            '<div>' +
            '<h3 class="text-xl font-bold text-white mb-4">ç§‘ç›®å¤ä¹ æƒé‡</h3>' +
            '<div class="space-y-4">' +
            ['æ•°æ®ç»“æ„', 'è®¡ç»„', 'æ“ä½œç³»ç»Ÿ', 'è®¡ç½‘'].map(subject =>
                    '<div class="grid grid-cols-3 gap-x-4 items-center">' +
                    `<label class="text-right text-slate-300">${subject}</label>` +
                    `<div class="col-span-2 weight-btn-group bg-slate-900/80 rounded-full p-1 flex" data-subject="${subject}">` +
                    '<button data-weight="2" class="w-full text-center rounded-full py-1 text-sm text-slate-300 transition-all">æ™®é€š</button>' +
                    '<button data-weight="4" class="w-full text-center rounded-full py-1 text-sm text-slate-300 transition-all active">é‡ç‚¹</button>' +
                    '<button data-weight="6" class="w-full text-center rounded-full py-1 text-sm text-slate-300 transition-all">æ ¸å¿ƒ</button>' +
                    '</div></div>'
            ).join('') +
            '</div></div>' +
            '<button id="generatePlanBtn" class="main-cta-btn text-white font-bold py-4 px-8 w-full rounded-full"><span class="text-xl">ğŸš€ ç”Ÿæˆä¸“å±è®¡åˆ’</span></button>' +
            '</div>';
    switchView('settings-container');

    const slider = document.getElementById('duration-slider');
    const display = document.getElementById('duration-display');
    slider.addEventListener('input', () => { display.textContent = (slider.value / 60).toFixed(1) + ' å°æ—¶'; });

    document.querySelectorAll('.weight-btn-group').forEach(group => {
      group.addEventListener('click', (e) => {
        if(e.target.tagName === 'BUTTON') {
          group.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
          e.target.classList.add('active');
        }
      });
    });

    document.getElementById('generatePlanBtn').addEventListener('click', () => {
      const duration = parseInt(slider.value, 10);
      const subjectWeights = {};
      document.querySelectorAll('.weight-btn-group[data-subject]').forEach(group => {
        subjectWeights[group.dataset.subject] = parseInt(group.querySelector('button.active').dataset.weight, 10);
      });
      const efficiencyMultiplier = parseFloat(document.querySelector('#efficiency-group button.active').dataset.multiplier);
      generateUniqueDailyPlan(duration, subjectWeights, efficiencyMultiplier);
      previousView = 'settings-container';
      renderPlanView(getTodayDateString());
    });
  }

  function displayStatisticsMain() {
    const container = document.getElementById('stats-main-container');
    const chapters = [...new Set(SYLLABUS.map(item => item[0] + ' - ' + item[1]))];
    const backButtonText = previousView === 'plan-container' ? 'è¿”å›è®¡åˆ’' : 'è¿”å›ä¸»é¡µ';

    let statsHTML =
            `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-white">å­¦ä¹ åˆ†æä¸­å¿ƒ</h2><button id="backFromStatsBtn" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-slate-500 transition-colors">${backButtonText}</button></div>` +
            '<div class="glass-card p-4 overflow-auto max-h-[70vh]"><div class="space-y-2">';

    chapters.forEach((chapterName, index) => {
      statsHTML +=
              `<button class="list-item-animation chapter-btn w-full text-left p-4 flex justify-between items-center hover:bg-slate-700/50 rounded-md transition-colors" data-chapter="${chapterName}" style="animation-delay: ${index * 20}ms;">` +
              `<span>${chapterName}</span>` +
              '<svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' +
              '</button>';
    });

    statsHTML += '</div></div><div class="mt-6 text-center"><button id="clearHistoryBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-500 transition-colors">æ¸…é™¤æ‰€æœ‰å­¦ä¹ è®°å½•</button></div>';

    container.innerHTML = statsHTML;
    switchView('stats-main-container');

    document.getElementById('backFromStatsBtn').addEventListener('click', () => navigateBack());
    document.getElementById('clearHistoryBtn').addEventListener('click', () => clearAllHistory());
    document.querySelectorAll('.chapter-btn').forEach(btn => btn.addEventListener('click', (e) => {
      const grandparentView = previousView;
      previousView = 'stats-main-container';
      displayChapterDetail(e.currentTarget.dataset.chapter, grandparentView);
    }));
  }

  function aggregateNotesForChapter(chapterName) {
    const aggregatedNotes = {};
    Object.keys(localStorage)
            .filter(k => k.startsWith('plan_'))
            .forEach(key => {
              const dateStr = key.substring(5);
              const planData = storage.get(key);
              if (!planData || !planData.plan) return;

              planData.plan.forEach(item => {
                const itemChapterName = `${item.subject} - ${item.chapter}`;
                if (itemChapterName === chapterName && item.notes && item.notes.length > 0) {
                  if (!aggregatedNotes[item.section]) {
                    aggregatedNotes[item.section] = [];
                  }
                  item.notes.forEach((note, index) => {
                    aggregatedNotes[item.section].push({
                      date: dateStr,
                      content: note,
                      index: index,
                    });
                  });
                }
              });
            });
    return aggregatedNotes;
  }

  function displayChapterDetail(chapterName, grandparentView) {
    const container = document.getElementById('chapter-detail-container');
    const history = storage.get('reviewHistory', {});
    const chapterSections = SYLLABUS.filter(item => (item[0] + ' - ' + item[1]) === chapterName);
    const today = new Date();
    const oneDay = 1000 * 60 * 60 * 24;

    let totalReviews = 0, totalMemoryStrength = 0;

    const sectionStrengths = chapterSections.map(s => {
      const historyItem = history[s[2]];
      const strength = historyItem ? Math.max(0.1, Math.exp(-Math.round((today - new Date(historyItem.lastReviewed)) / oneDay) / 14)) : 0.1;
      totalReviews += historyItem ? historyItem.reviewCount : 0;
      totalMemoryStrength += strength;
      return { name: s[2], strength: strength, reviewCount: historyItem ? historyItem.reviewCount : 0, lastReviewed: historyItem ? historyItem.lastReviewed : 'ä»æœª' };
    }).sort((a, b) => a.strength - b.strength);

    const weakestTopics = sectionStrengths.slice(0, 3);
    const mastery = (totalMemoryStrength / chapterSections.length * 100).toFixed(1);

    let mainHTML =
            `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">${chapterName}</h2><button id="backToStatsMainBtn" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-slate-500 transition-colors">è¿”å›åˆ—è¡¨</button></div>` +
            '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">' +
            `<div class="glass-card p-4 text-center"><p class="text-sm text-slate-400">ç« èŠ‚æŒæ¡åº¦</p><p class="text-3xl font-bold text-green-400">${mastery}%</p></div>` +
            `<div class="glass-card p-4 text-center"><p class="text-sm text-slate-400">æ€»å¤ä¹ æ¬¡æ•°</p><p class="text-3xl font-bold text-sky-400">${totalReviews}</p></div>` +
            `<div class="glass-card p-4 text-center"><p class="text-sm text-slate-400">å½“å‰æœ€æ˜“å¿˜</p><p class="text-lg font-bold text-red-400 truncate mt-1" title="${weakestTopics.length > 0 ? weakestTopics[0].name : ''}">${weakestTopics.length > 0 ? weakestTopics[0].name : 'æ— '}</p></div>` +
            '</div>' +
            '<div class="glass-card p-6">' +
            '<h3 class="font-bold text-white mb-4">é—å¿˜æ›²çº¿ (è®°å¿†å¼ºåº¦)</h3><div class="h-60"><canvas id="chapter-chart"></canvas></div>' +
            '</div>' +
            '<div class="mt-6 glass-card p-6">' +
            '<h3 class="font-bold text-white mb-3">è–„å¼±ç‚¹å¼ºåŒ–</h3><p class="text-sm text-slate-400 mb-4">æ ¹æ®å½“å‰è®°å¿†å¼ºåº¦ï¼Œä¸ºä½ æ‰¾åˆ°æœ€éœ€è¦å·©å›ºçš„çŸ¥è¯†ç‚¹ï¼š</p>' +
            '<div class="space-y-2 mb-4">' + (weakestTopics.length > 0 ? weakestTopics.map(t => `<p class="text-red-400 font-semibold pl-4">- ${t.name}</p>`).join('') : '<p class="text-slate-500 text-center">æœ¬ç« å·²å…¨éƒ¨æŒæ¡ï¼</p>') + '</div>' +
            (weakestTopics.length > 0 ? '<div class="flex space-x-4"><button id="reinforce-ai-btn" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-3 rounded-lg transition-colors">AIä¸“é¡¹ç»ƒä¹ </button><button id="reinforce-priority-btn" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 px-3 rounded-lg transition-colors">åŠ å…¥ä¸‹æ¬¡ä¼˜å…ˆå¤ä¹ </button></div>' : '') +
            '</div>';

    const aggregatedNotes = aggregateNotesForChapter(chapterName);
    const hasNotes = Object.keys(aggregatedNotes).length > 0;
    let notesHTML = '<div class="mt-6 glass-card p-6">' +
            '<h3 class="font-bold text-white mb-4">ç›¸å…³ç¬”è®°</h3>';
    if (hasNotes) {
      notesHTML += '<div class="space-y-4 max-h-60 overflow-y-auto pr-2">';
      for (const section in aggregatedNotes) {
        notesHTML += `<div><p class="font-semibold text-slate-300 mb-2">${section}</p>`;
        notesHTML += '<div class="pl-4 flex flex-wrap gap-2">';
        aggregatedNotes[section].forEach(note => {
          notesHTML += `<button class="past-note-btn bg-indigo-900/80 text-xs text-indigo-300 py-1 px-2 rounded-md hover:bg-indigo-800" data-note-content="${escape(note.content)}" data-note-title="${escape(`${section} - ${note.date} / ç¬”è®° ${note.index + 1}`)}">${note.date.slice(5)} / ç¬”è®° ${note.index + 1}</button>`;
        });
        notesHTML += '</div></div>';
      }
      notesHTML += '</div>';
    } else {
      notesHTML += '<p class="text-slate-500 text-center">æš‚æ— ç›¸å…³ç¬”è®°ã€‚</p>';
    }
    notesHTML += '</div>';

    container.innerHTML = mainHTML + notesHTML;
    switchView('chapter-detail-container');

    createForgettingCurveChart('chapter-chart', chapterSections, history);

    document.getElementById('backToStatsMainBtn').addEventListener('click', () => {
      previousView = grandparentView;
      displayStatisticsMain();
    });

    container.querySelectorAll('.past-note-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const title = unescape(e.currentTarget.dataset.noteTitle);
        const content = unescape(e.currentTarget.dataset.noteContent);
        DOM.aiModal.title.textContent = title;
        DOM.aiModal.result.innerHTML = `<div class="whitespace-pre-wrap">${content}</div>`;
        DOM.aiModal.loading.style.display = 'none';
        showModal(DOM.aiModal);
      });
    });

    const reinforceAiBtn = document.getElementById('reinforce-ai-btn');
    if (reinforceAiBtn) reinforceAiBtn.addEventListener('click', () => handleReinforceAI(weakestTopics));
    const reinforcePriorityBtn = document.getElementById('reinforce-priority-btn');
    if(reinforcePriorityBtn) reinforcePriorityBtn.addEventListener('click', () => handleReinforcePriority(weakestTopics));
  }

  function createForgettingCurveChart(canvasId, chapterSections, history) {
    const chartCanvas = document.getElementById(canvasId);
    if (!chartCanvas) return;
    const ctx = chartCanvas.getContext('2d');

    if (window.chapterChartInstance) {
      window.chapterChartInstance.destroy();
    }

    const today = new Date();
    const oneDay = 1000 * 60 * 60 * 24;

    const labels = chapterSections.map(s => s[2]);
    const data = chapterSections.map(s => {
      const historyItem = history[s[2]];
      const strength = historyItem ? Math.max(0.1, Math.exp(-Math.round((today - new Date(historyItem.lastReviewed)) / oneDay) / 14)) * 100 : 10;
      return strength.toFixed(1);
    });

    const backgroundColors = data.map(d => {
      if (d < 30) return 'rgba(239, 68, 68, 0.5)';
      if (d < 70) return 'rgba(250, 204, 21, 0.5)';
      return 'rgba(52, 211, 153, 0.5)';
    });
    const borderColors = data.map(d => {
      if (d < 30) return 'rgba(239, 68, 68, 1)';
      if (d < 70) return 'rgba(250, 204, 21, 1)';
      return 'rgba(52, 211, 153, 1)';
    });

    window.chapterChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'è®°å¿†å¼ºåº¦ (%)',
          data: data,
          backgroundColor: backgroundColors,
          borderColor: borderColors,
          borderWidth: 1,
          borderRadius: 4,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, max: 100, grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#94a3b8' } },
          x: { grid: { color: 'rgba(148, 163, 184, 0.1)' }, ticks: { color: '#94a3b8', autoSkip: true, maxTicksLimit: 8 } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (context) => `è®°å¿†å¼ºåº¦: ${context.raw}%` } }
        }
      }
    });
  }

  function displayTimelinePage() {
    const container = document.getElementById('timeline-container');
    const allPlans = Object.keys(localStorage).filter(k => k.startsWith('plan_')).map(key => {
      const dateStr = key.substring(5);
      const planData = storage.get(key);
      if (!planData || !planData.plan || planData.plan.length === 0) return null;
      const completedCount = planData.plan.filter(p => p.completed).length;
      const completionRate = (completedCount / planData.plan.length * 100).toFixed(0);
      const subjects = [...new Set(planData.plan.map(p => p.subject))];
      const totalDuration = planData.plan.reduce((sum, p) => sum + p.duration, 0);
      return { dateStr, planData, completedCount, completionRate, subjects, totalDuration };
    }).filter(Boolean).sort((a, b) => new Date(b.dateStr) - new Date(a.dateStr));

    let listHTML = allPlans.length > 0
            ? allPlans.map((p, index) => {
              const subjectTags = p.subjects.map(s => `<span class="bg-slate-600 text-xs font-semibold px-2 py-1 rounded-full">${s}</span>`).join(' ');
              return `<div class="list-item-animation glass-card p-4" style="animation-delay: ${index * 50}ms;"><div class="flex justify-between items-start"><div><h4 class="text-lg font-bold text-white">${p.dateStr}</h4><p class="text-sm text-slate-400">å®Œæˆç‡: ${p.completionRate}% (${p.completedCount}/${p.planData.plan.length}) Â· æ€»è€—æ—¶: ${(p.totalDuration/60).toFixed(1)}å°æ—¶</p></div><button class="view-past-plan-btn bg-indigo-600 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-indigo-500" data-date="${p.dateStr}">æŸ¥çœ‹è¯¦æƒ…</button></div><div class="mt-3 flex flex-wrap gap-2">${subjectTags}</div></div>`;
            }).join('')
            : '<p class="text-slate-500 text-center py-8">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å¼€å¯ä¸€æ¬¡å¤ä¹ å§ï¼</p>';

    container.innerHTML =
            '<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-white">å®Œæ•´å¤ä¹ å†å²</h2><button id="backToDashboardFromTimeline" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-slate-500 transition-colors">è¿”å›ä¸»é¡µ</button></div>' +
            '<div id="calendar-wrapper" class="mb-6"></div><div><h3 class="text-xl font-bold text-white mb-4">è¯¦ç»†è®°å½•</h3><div class="space-y-4">' + listHTML + '</div></div>';

    renderCalendar(document.getElementById('calendar-wrapper'), new Date());
    switchView('timeline-container');

    document.getElementById('backToDashboardFromTimeline').addEventListener('click', () => {
      previousView = 'timeline-container';
      navigateTo('dashboard-container');
    });
    container.querySelectorAll('.view-past-plan-btn').forEach(btn => btn.addEventListener('click', (e) => {
      previousView = 'timeline-container';
      displayPastPlanDetail(e.currentTarget.dataset.date);
    }));
  }

  function renderCalendar(container, date) {
    if(!container) return;
    const plans = Object.keys(localStorage).filter(k => k.startsWith('plan_')).reduce((acc, k) => {
      const planData = storage.get(k);
      if (planData && planData.plan) {
        const completedCount = planData.plan.filter(p => p.completed).length;
        const totalCount = planData.plan.length;
        acc[k.substring(5)] = { completed: completedCount, total: totalCount };
      }
      return acc;
    }, {});

    const year = date.getFullYear(), month = date.getMonth();
    const monthName = `${year}å¹´ ${month + 1}æœˆ`;
    const firstDay = (new Date(year, month, 1).getDay() + 6) % 7; // Monday as first day
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    let calendarHTML = `<div class="glass-card p-4"><div class="flex justify-between items-center mb-4"><button class="prev-month-btn p-2 rounded-md hover:bg-slate-700/50">&lt;</button><h3 class="text-xl font-bold text-white">${monthName}</h3><button class="next-month-btn p-2 rounded-md hover:bg-slate-700/50">&gt;</button></div><div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2"><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div><div>æ—¥</div></div><div class="grid grid-cols-7 gap-1">`;
    for (let i = 0; i < firstDay; i++) calendarHTML += '<div></div>';
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const planInfo = plans[dateStr];
      let colorClass = 'bg-slate-700/40';
      let titleText = dateStr;
      let buttonClass = '';

      if (planInfo) {
        const completionRate = planInfo.total > 0 ? planInfo.completed / planInfo.total : 0;
        if (completionRate === 0 && planInfo.total > 0) colorClass = 'bg-amber-800/80';
        else if (completionRate < 0.5) colorClass = 'bg-green-900/80';
        else if (completionRate < 1) colorClass = 'bg-green-800/80';
        else colorClass = 'bg-green-600/80';
        titleText += `\nå®Œæˆ: ${planInfo.completed}/${planInfo.total}`;
        buttonClass = 'cursor-pointer hover:ring-2 hover:ring-indigo-400';
      }

      calendarHTML += `<div class="h-10 ${colorClass} ${buttonClass} rounded-md flex items-center justify-center transition-all" data-date="${dateStr}" title="${titleText}">${day}</div>`;
    }
    calendarHTML += '</div></div>';
    container.innerHTML = calendarHTML;

    container.querySelector('.prev-month-btn').addEventListener('click', () => renderCalendar(container, new Date(year, month - 1, 1)));
    container.querySelector('.next-month-btn').addEventListener('click', () => renderCalendar(container, new Date(year, month + 1, 1)));
    container.querySelectorAll('[data-date]').forEach(cell => {
      if (cell.classList.contains('cursor-pointer')) {
        cell.addEventListener('click', (e) => {
          previousView = 'timeline-container';
          displayPastPlanDetail(e.currentTarget.dataset.date);
        });
      }
    });
  }

  function displayPastPlanDetail(dateStr) {
    const planData = storage.get('plan_' + dateStr);
    if (!planData || !planData.plan) return;
    const container = document.getElementById('past-plan-container');
    const { plan } = planData;
    const completedCount = plan.filter(p => p.completed).length;
    const completionRate = plan.length > 0 ? (completedCount / plan.length * 100).toFixed(0) : 0;
    const totalDuration = plan.reduce((sum, p) => sum + p.duration, 0);
    const subjectDurations = plan.reduce((acc, item) => {
      acc[item.subject] = (acc[item.subject] || 0) + item.duration;
      return acc;
    }, {});

    const planDetailsHTML = plan.map(item => {
      const notesButtonsHTML = (item.notes && item.notes.length > 0) ?
              '<div class="pl-4 mt-2 flex flex-wrap gap-2">' +
              item.notes.map((note, idx) =>
                      `<button class="past-note-btn bg-indigo-900/80 text-xs text-indigo-300 py-1 px-2 rounded-md hover:bg-indigo-800" data-note-content="${escape(note)}" data-note-title="${escape(`${dateStr} / ç¬”è®° ${idx + 1}`)}">${dateStr.slice(5)} / ç¬”è®° ${idx + 1}</button>`
              ).join('') +
              '</div>' : '';

      return `<div><p class="font-semibold ${item.completed ? 'text-green-400' : 'text-slate-300'}">${item.completed ? 'âœ”' : 'âœ–'} ${item.section}</p>${notesButtonsHTML}</div>`;
    }).join('');

    container.innerHTML =
            `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-white">${dateStr} å¤ç›˜</h2><button id="backFromPastPlanBtn" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-slate-500 transition-colors">è¿”å›</button></div>` +
            '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">' +
            `<div class="glass-card p-4 text-center"><p class="text-sm text-slate-400">å®Œæˆç‡</p><p class="text-3xl font-bold text-green-400">${completionRate}%</p></div>` +
            `<div class="glass-card p-4 text-center"><p class="text-sm text-slate-400">æ€»è€—æ—¶</p><p class="text-3xl font-bold text-sky-400">${(totalDuration/60).toFixed(1)}å°æ—¶</p></div>` +
            `<div class="glass-card p-4 text-center"><p class="text-sm text-slate-400">å¤ä¹ ç§‘ç›®æ•°</p><p class="text-3xl font-bold text-amber-400">${Object.keys(subjectDurations).length}</p></div>` +
            '</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="glass-card p-6"><h3 class="font-bold text-white mb-4">å„ç§‘è€—æ—¶åˆ†å¸ƒ</h3><canvas id="past-plan-chart"></canvas></div>' +
            '<div class="glass-card p-4 max-h-[400px] overflow-y-auto"><h3 class="font-bold text-white p-2">è®¡åˆ’è¯¦æƒ…ä¸ç¬”è®°</h3><div class="space-y-3">' + planDetailsHTML + '</div></div></div>';

    switchView('past-plan-container');
    document.getElementById('backFromPastPlanBtn').addEventListener('click', () => navigateBack());

    container.querySelectorAll('.past-note-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const title = unescape(e.currentTarget.dataset.noteTitle);
        const content = unescape(e.currentTarget.dataset.noteContent);
        DOM.aiModal.title.textContent = title;
        DOM.aiModal.result.innerHTML = `<div class="whitespace-pre-wrap">${content}</div>`;
        DOM.aiModal.loading.style.display = 'none';
        showModal(DOM.aiModal);
      });
    });

    const chartCanvas = document.getElementById('past-plan-chart');
    if (chartCanvas && Object.keys(subjectDurations).length > 0) {
      new Chart(chartCanvas.getContext('2d'), { type: 'pie', data: { labels: Object.keys(subjectDurations), datasets: [{ data: Object.values(subjectDurations), backgroundColor: ['#38bdf8', '#fbbf24', '#34d399', '#f472b6'] }] }, options: { responsive: true, plugins: { legend: { position: 'top', labels: { color: '#cbd5e1' } } } } });
    }
  }

  function displayQuestionHistory() {
    const container = document.getElementById('question-history-container');
    const history = storage.get('aiQuestionHistory', []);
    let historyHTML = '';
    if (history.length > 0) {
      history.slice().reverse().forEach((item, index) => {
        const questionText = (item.question || 'é¢˜ç›®åŠ è½½å¤±è´¥');
        const optionsText = (item.options || '');
        const explanationText = (item.explanation || 'è§£æåŠ è½½å¤±è´¥');
        historyHTML +=
                `<div class="list-item-animation glass-card p-6" style="animation-delay: ${index * 50}ms;"><div class="prose prose-invert prose-p:text-slate-300 prose-strong:text-white"><p class="font-semibold text-white">${index + 1}. ${questionText}</p><div class="text-slate-300 my-2 whitespace-pre-wrap">${optionsText}</div></div><div class="mt-4"><button class="toggle-answer-btn text-indigo-400 text-sm font-bold hover:text-indigo-300">æ˜¾ç¤ºç­”æ¡ˆä¸è§£æ</button><div class="answer-content hidden mt-3 pt-3 border-t border-slate-700/50 prose prose-invert prose-p:text-slate-300 prose-strong:text-green-400"><p><b>æ­£ç¡®ç­”æ¡ˆ: ${item.answer || ''}</b></p><p class="mt-1">${explanationText}</p></div></div><div class="flex justify-end mt-2"><button class="review-concepts-btn text-xs bg-sky-800 hover:bg-sky-700 text-white font-bold py-1 px-3 rounded-md" data-topics='${JSON.stringify(item.topics)}'>å¤ä¹ ç›¸å…³çŸ¥è¯†ç‚¹</button></div><p class="text-xs text-slate-500 text-right mt-2">${item.date}</p></div>`;
      });
    } else {
      historyHTML = '<p class="text-slate-500 text-center py-8">ä½ çš„é¢˜åº“è¿˜æ˜¯ç©ºçš„ï¼Œå¿«å»ç»ƒä¹ å‡ é“é¢˜å§ï¼</p>';
    }
    container.innerHTML = '<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-white">AI æ™ºèƒ½é¢˜åº“</h2><button id="backToDashboardFromHistory" class="bg-slate-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-slate-500 transition-colors">è¿”å›ä¸»é¡µ</button></div><div class="space-y-4">' + historyHTML + '</div>';

    switchView('question-history-container');
    document.getElementById('backToDashboardFromHistory').addEventListener('click', () => {
      previousView = 'question-history-container';
      navigateTo('dashboard-container');
    });
    container.querySelectorAll('.toggle-answer-btn').forEach(btn => btn.addEventListener('click', e => {
      const content = e.target.nextElementSibling;
      content.classList.toggle('hidden');
      e.target.textContent = content.classList.contains('hidden') ? 'æ˜¾ç¤ºç­”æ¡ˆä¸è§£æ' : 'éšè—ç­”æ¡ˆä¸è§£æ';
    }));
    container.querySelectorAll('.review-concepts-btn').forEach(btn => btn.addEventListener('click', e => handleReviewConcepts(JSON.parse(e.currentTarget.dataset.topics))));
  }

  function attachPlanEventListeners(dateStr) {
    const isToday = dateStr === getTodayDateString();
    const planData = storage.get('plan_' + dateStr);

    document.getElementById('exportBtn').addEventListener('click', () => exportToCSV(dateStr));
    document.getElementById('showStatsBtn').addEventListener('click', () => {
      previousView = 'plan-container';
      displayStatisticsMain();
    });
    document.getElementById('backToDashboardBtn').addEventListener('click', () => {
      previousView = 'plan-container';
      navigateTo('dashboard-container');
    });

    if (isToday && !planData.isFinished) {
      document.querySelectorAll('.task-knob').forEach(el => el.addEventListener('click', e => { e.stopPropagation(); handleTaskCompletionToggle(e, dateStr); }));
      document.querySelectorAll('.flex-grow.cursor-pointer').forEach(el => el.addEventListener('click', e => displayLearningCard(e.currentTarget.dataset.planIndex, dateStr)));
      document.getElementById('finishDayBtn')?.addEventListener('click', () => finishAndShowSummary(dateStr));
      const resetBtn = document.getElementById('resetDurationBtn');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          showConfirmationModal('é‡è®¾ä»Šæ—¥è®¡åˆ’', 'è¿™å°†æ¸…é™¤å½“å‰çš„è®¡åˆ’å¹¶è¿”å›è®¾ç½®é¡µé¢é‡æ–°ç”Ÿæˆã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', () => {
            previousView = 'dashboard-container';
            displaySettings();
          });
        });
      }
    }

    document.querySelectorAll('.ai-btn').forEach(b => {
      if (b.dataset.type === 'question') b.addEventListener('click', handleQuestionOptions);
      else b.addEventListener('click', handleAIButtonClick);
    });
  }

  function handleTaskCompletionToggle(event, dateStr, forceComplete = false) {
    const planIndex = event.currentTarget.dataset.planIndex;
    const planItemElement = document.querySelector(`.list-item-animation[data-plan-index="${planIndex}"]`);
    const knob = planItemElement.querySelector('.task-knob');
    const text = planItemElement.querySelector('.plan-text');
    const isCompleted = forceComplete ? true : !knob.classList.contains('completed');
    knob.classList.toggle('completed', isCompleted);
    text.classList.toggle('completed', isCompleted);
    const planData = storage.get(`plan_${dateStr}`);
    const item = planData.plan[planIndex];
    if (item) item.completed = isCompleted;
    storage.set(`plan_${dateStr}`, planData);
    if (isCompleted) {
      const history = storage.get('reviewHistory', {});
      const sectionName = item.section;
      const historyItem = history[sectionName] || { reviewCount: 0 };
      historyItem.lastReviewed = dateStr;
      historyItem.reviewCount = (historyItem.reviewCount || 0) + 1;
      history[sectionName] = historyItem;
      storage.set('reviewHistory', history);
    }
  }

  function exportToCSV(dateStr) {
    const planData = storage.get(`plan_${dateStr}`);
    if (!planData || !planData.plan) return showNotification('æ²¡æœ‰å¯å¯¼å‡ºçš„è®¡åˆ’ã€‚', true);
    let csvContent = "data:text/csv;charset=utf-8,\uFEFFç§‘ç›®,ç« èŠ‚,å°èŠ‚,å®ŒæˆçŠ¶æ€,ç¬”è®°,å¤ä¹ æ—¥æœŸ\r\n";
    planData.plan.forEach(item => {
      const notesText = (item.notes || []).map((note, idx) => `ç¬”è®° ${idx + 1}: ${note}`).join('\n');
      const notesCsv = notesText ? `"${notesText.replace(/"/g, '""')}"` : "";
      csvContent += [`"${item.subject}"`, `"${item.chapter}"`, `"${item.section}"`, item.completed ? "å·²å®Œæˆ" : "æœªå®Œæˆ", notesCsv, dateStr].join(",") + "\r\n";
    });
    const link = document.createElement("a");
    link.href = encodeURI(csvContent);
    link.download = `408-å¤ä¹ è®¡åˆ’-${dateStr}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function showConfirmationModal(title, text, onConfirm) {
    const modal = { backdrop: DOM.confirmModal.backdrop, title: DOM.confirmModal.title, text: DOM.confirmModal.text, okBtn: DOM.confirmModal.okBtn, cancelBtn: DOM.confirmModal.cancelBtn };
    modal.title.textContent = title;
    modal.text.textContent = text;
    modal.backdrop.classList.remove('hidden');
    const okHandler = () => { onConfirm(); hide(); };
    const hide = () => {
      modal.backdrop.classList.add('hidden');
      modal.okBtn.removeEventListener('click', okHandler);
      modal.cancelBtn.removeEventListener('click', hide);
    };
    modal.okBtn.addEventListener('click', okHandler, { once: true });
    modal.cancelBtn.addEventListener('click', hide, { once: true });
  }

  function clearAllHistory() {
    showConfirmationModal('æ¸…é™¤æ‰€æœ‰è®°å½•', 'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­¦ä¹ è®°å½•å’ŒAIé¢˜åº“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', () => {
      localStorage.removeItem('reviewHistory');
      localStorage.removeItem('aiQuestionHistory');
      localStorage.removeItem('priorityReviewPool');
      Object.keys(localStorage).filter(k => k.startsWith('plan_')).forEach(k => localStorage.removeItem(k));
      showNotification('æ‰€æœ‰å­¦ä¹ è®°å½•å’Œè®¡åˆ’å†å²å·²æ¸…é™¤ã€‚');
      navigateTo('dashboard-container');
    });
  }

  function switchView(viewId) {
    document.querySelectorAll('.view-container').forEach(el => {
      el.classList.toggle('hidden-view', el.id !== viewId);
      el.style.position = el.id === viewId ? 'relative' : 'absolute';
    });
  }

  function navigateTo(viewId, data = null) {
    const viewFunctions = {
      'dashboard-container': displayDashboard,
      'plan-container': () => renderPlanView(data),
      'timeline-container': displayTimelinePage,
      'stats-main-container': displayStatisticsMain,
      'settings-container': displaySettings,
      'summary-container': () => displaySummaryView(data),
    };
    const func = viewFunctions[viewId] || displayDashboard;
    func();
  }

  function navigateBack() {
    const targetView = previousView || 'dashboard-container';
    let data = null;
    if (targetView === 'plan-container') {
      data = currentPlanDate;
    }
    navigateTo(targetView, data);
  }

  // --- Modals & AI Section ---
  const DOM = {}; // Centralized DOM elements
  let currentNoteSaveHandler = null;
  let currentGenerateQuestionHandler = null;

  function setupModal(modalConfig) {
    modalConfig.backdrop.addEventListener('click', e => { if (e.target === modalConfig.backdrop) hideModal(modalConfig); });
    modalConfig.backdrop.querySelector('.modal-close')?.addEventListener('click', () => hideModal(modalConfig));
  }
  function showModal(modalConfig) { modalConfig.backdrop.classList.remove('hidden'); }
  function hideModal(modalConfig) { modalConfig.backdrop.classList.add('hidden'); }
  function showNotification(message, isError = false, duration = 3000) {
    const toast = DOM.toast;
    toast.textContent = message;
    toast.style.backgroundColor = isError ? '#ef4444' : '#22c55e';
    toast.classList.remove('translate-y-20', 'opacity-0');
    setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), duration);
  }

  function showNoteModal(dateStr, planIndex, noteIndex) {
    const isNewNote = noteIndex === -1;
    const planData = storage.get('plan_' + dateStr);
    const item = planData.plan[planIndex];
    const notes = item.notes || [];

    const nModal = DOM.notesModal;
    nModal.title.textContent = isNewNote ? `ä¸º "${item.section}" æ·»åŠ æ–°ç¬”è®°` : `ç¼–è¾‘ç¬”è®° ${noteIndex + 1}`;
    nModal.textarea.value = isNewNote ? '' : notes[noteIndex];
    nModal.error.classList.add('hidden');

    if (currentNoteSaveHandler) {
      nModal.saveBtn.removeEventListener('click', currentNoteSaveHandler);
    }

    currentNoteSaveHandler = () => {
      const noteContent = nModal.textarea.value.trim();
      if (!noteContent) {
        nModal.error.textContent = 'ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©ºã€‚';
        nModal.error.classList.remove('hidden');
        return;
      }

      if (isNewNote) {
        notes.push(noteContent);
      } else {
        notes[noteIndex] = noteContent;
      }
      item.notes = notes;
      storage.set(`plan_${dateStr}`, planData);
      hideModal(nModal);
      showNotification('ç¬”è®°å·²ä¿å­˜ï¼');

      const notesContainerId = `notes-container-${dateStr.replace(/-/g, '')}-${planIndex}`;
      const notesContainer = document.getElementById(notesContainerId);
      updateNotesUI(notesContainer, dateStr, planIndex);
    };

    nModal.saveBtn.addEventListener('click', currentNoteSaveHandler);
    nModal.polishBtn.onclick = () => handleAIPolish(nModal.textarea);
    showModal(nModal);
  }


  async function callGemini(prompt) {
    const apiKey = storage.get('apiKey');
    if (!apiKey) throw new Error("API å¯†é’¥æœªè®¾ç½®ã€‚è¯·åœ¨è®¾ç½®ä¸­é…ç½®ã€‚");
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
    if (!response.ok) {
      if (response.status === 403 || response.status === 400) showAPIKeyModal(true);
      const errorData = await response.json();
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${errorData.error.message}`);
    }
    const data = await response.json();
    if (!data.candidates?.[0]?.content?.parts) {
      if (data.candidates?.[0]?.finishReason === 'SAFETY') throw new Error("AI å› ä¸ºå®‰å…¨åŸå› æ‹’ç»å›ç­”ã€‚");
      throw new Error("ä»APIè¿”å›äº†æ— æ•ˆçš„æ•°æ®ç»“æ„ã€‚");
    }
    return data.candidates[0].content.parts[0].text;
  }

  function ensureApiKey() {
    if (!storage.get('apiKey')) {
      showAPIKeyModal(true);
      return false;
    }
    return true;
  }

  async function handleAIButtonClick(event) {
    if (!ensureApiKey()) return;
    const { type, topic } = event.currentTarget.dataset;
    let prompt = "", title = "";
    const formattingRules = "ä½ çš„å›å¤å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š\n(1) å¦‚æœæœ‰æ ‡é¢˜ï¼Œæ ‡é¢˜å’Œæ­£æ–‡ä¹‹é—´å¿…é¡»æœ‰ä¸”ä»…æœ‰ä¸€è¡Œç©ºè¡Œã€‚\n(2) æ­£æ–‡åˆ†ç‚¹è¯´æ˜å¿…é¡»ä½¿ç”¨'(1)'ã€'(2)'è¿™æ ·çš„æ ¼å¼å¼€å¤´ã€‚\n(3) æ‰€æœ‰åˆ†ç‚¹å’Œæ®µè½ä¹‹é—´ä¸å…è®¸å‡ºç°é¢å¤–çš„ç©ºè¡Œã€‚\n(4) å¦‚æœéœ€è¦å¼ºè°ƒæŸä¸ªå†…å®¹ï¼Œå¿…é¡»ä½¿ç”¨'**'å°†è¯¥å†…å®¹åŒ…è£¹èµ·æ¥ã€‚\nè¯·ç›´æ¥è¾“å‡ºæ ¼å¼åŒ–åçš„å†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šè¯´æ˜æ–‡å­—ã€‚";
    if (type === 'explain') {
      title = `âœ¨ æ·±å…¥è§£æ: ${topic}`;
      prompt = `ä½œä¸ºä¸€åé¡¶çº§çš„408è®¡ç®—æœºè€ƒç ”è¾…å¯¼è€å¸ˆï¼Œè¯·ä¸ºå­¦ç”Ÿæä¾›â€œ${topic}â€è¿™ä¸ªçŸ¥è¯†ç‚¹çš„æ·±å…¥è§£æã€‚å†…å®¹åº”åŒ…æ‹¬æ ¸å¿ƒå®šä¹‰ã€å…³é”®ç‰¹å¾æˆ–æ­¥éª¤ã€ä»¥åŠå…¸å‹åº”ç”¨åœºæ™¯ã€‚\n\n${formattingRules}`;
    } else if (type === 'summary') {
      title = "âœ¨ ä»Šæ—¥æ™ºèƒ½å°ç»“";
      prompt = `æˆ‘æ˜¯ä¸€åæ­£åœ¨å¤‡è€ƒ408è®¡ç®—æœºè€ƒç ”çš„å­¦ç”Ÿï¼Œä»Šå¤©çš„å¤ä¹ å†…å®¹åŒ…æ‹¬ï¼š${topic}ã€‚è¯·ä½ ä»¥ä¸€ä½èµ„æ·±è€å¸ˆçš„è§†è§’ï¼Œä¸ºæˆ‘ç”Ÿæˆä¸€æ®µ150å­—å·¦å³çš„æ€»ç»“ï¼Œç‚¹å‡ºè¿™äº›çŸ¥è¯†ç‚¹ä¹‹é—´çš„å†…åœ¨è”ç³»ï¼Œæˆ–è€…å®ƒä»¬åœ¨è®¡ç®—æœºç§‘å­¦ä½“ç³»ä¸­çš„ä½ç½®å’Œé‡è¦æ€§ã€‚\n\n${formattingRules}`;
    }
    showModal(DOM.aiModal);
    DOM.aiModal.title.textContent = title;
    DOM.aiModal.loading.style.display = 'flex';
    DOM.aiModal.result.innerHTML = '';
    try {
      const text = await callGemini(prompt);
      DOM.aiModal.result.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    } catch (error) {
      DOM.aiModal.result.innerHTML = `æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹å‡ºé”™äº†ã€‚<br>é”™è¯¯ä¿¡æ¯: ${error.message}`;
    } finally {
      DOM.aiModal.loading.style.display = 'none';
    }
  }

  function handleQuestionOptions(event) {
    if (!ensureApiKey()) return;
    const planIndex = event.currentTarget.dataset.planIndex;
    const todayStr = getTodayDateString();
    const planData = storage.get(`plan_${todayStr}`);
    const planItem = planData.plan[planIndex];
    const allPlanItems = planData.plan;

    const qModal = DOM.questionOptionsModal;
    const syllabusEntry = SYLLABUS.find(s => s[2] === planItem.section);
    const subTopics = syllabusEntry ? syllabusEntry[5] : [];
    qModal.list.innerHTML = subTopics.map(topic => `<label class="sub-topic-label flex items-center"><input type="checkbox" value="${topic}" class="hidden sub-topic-checkbox"><span class="border-2 border-slate-600 rounded-full px-3 py-1 text-sm cursor-pointer hover:bg-slate-700 transition-colors">${topic}</span></label>`).join('');
    qModal.selectAll.checked = false;
    qModal.crossTopic.checked = false;
    qModal.error.classList.add('hidden');
    if(currentGenerateQuestionHandler) qModal.generateBtn.removeEventListener('click', currentGenerateQuestionHandler);
    currentGenerateQuestionHandler = () => generateAIQuestion(planItem, allPlanItems);
    qModal.generateBtn.addEventListener('click', currentGenerateQuestionHandler);
    showModal(qModal);
  }

  async function generateAIQuestion(planItem, allPlanItems) {
    const qModal = DOM.questionOptionsModal;
    const selectedTopics = Array.from(qModal.list.querySelectorAll('.sub-topic-checkbox:checked')).map(cb => cb.value);
    if (selectedTopics.length === 0 && !qModal.crossTopic.checked) {
      qModal.error.textContent = 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ ¸å¿ƒè€ƒç‚¹ï¼Œæˆ–å‹¾é€‰â€œè·¨çŸ¥è¯†ç‚¹ç»¼åˆè€ƒå¯Ÿâ€ã€‚';
      return qModal.error.classList.remove('hidden');
    }
    qModal.error.classList.add('hidden');
    qModal.generateBtnText.textContent = 'ç”Ÿæˆä¸­...';
    qModal.generateBtnSpinner.classList.remove('hidden');
    qModal.generateBtn.disabled = true;

    const formattingRules = "ä½ çš„å›å¤å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™çš„æ–‡å­—è¯´æ˜:\n[é¢˜ç›®]\né¢˜ç›®å†…å®¹\n[é€‰é¡¹]\nA) é€‰é¡¹A\nB) é€‰é¡¹B\nC) é€‰é¡¹C\nD) é€‰é¡¹D\n[ç­”æ¡ˆ]\næ­£ç¡®é€‰é¡¹å­—æ¯\n[è§£æ]\nè¯¦ç»†è§£æå†…å®¹";
    let prompt;
    if (qModal.crossTopic.checked) {
      const otherTopics = allPlanItems.filter(p => p.section !== planItem.section);
      const crossTopicName = otherTopics.length > 0 ? otherTopics[Math.floor(Math.random() * otherTopics.length)].section : "è®¡ç®—æœºç½‘ç»œåŸºç¡€";
      const primaryTopic = selectedTopics.length > 0 ? selectedTopics.join('ã€') : planItem.section;
      prompt = `ä½œä¸ºä¸€å408è€ƒç ”å‘½é¢˜ä¸“å®¶ï¼Œè¯·å‡ºä¸€é“é«˜è´¨é‡çš„ã€è·¨çŸ¥è¯†ç‚¹ç»¼åˆé€‰æ‹©é¢˜ã€‘ã€‚è¦æ±‚å°†æ ¸å¿ƒè€ƒç‚¹ [${primaryTopic}] ä¸å¦ä¸€ä¸ªè€ƒç‚¹ [${crossTopicName}] ç»“åˆèµ·æ¥è¿›è¡Œè€ƒå¯Ÿï¼Œæ¨¡æ‹ŸçœŸå®è€ƒé¢˜çš„ç»¼åˆæ€§ã€‚\n\n${formattingRules}`;
    } else {
      prompt = `ä½œä¸ºä¸€å408è€ƒç ”å‘½é¢˜ä¸“å®¶ï¼Œè¯·ä¸¥æ ¼å›´ç»•ä»¥ä¸‹æ ¸å¿ƒè€ƒç‚¹å‡ºé¢˜ï¼š[${selectedTopics.join('ã€')}]ï¼Œå‡ºä¸€é“é«˜è´¨é‡çš„å•é¡¹é€‰æ‹©é¢˜ã€‚\n\n${formattingRules}`;
    }
    try {
      const rawResponse = await callGemini(prompt);
      hideModal(qModal);
      const q = {
        question: rawResponse.split('[é¢˜ç›®]')[1]?.split('[é€‰é¡¹]')[0]?.trim(), options: rawResponse.split('[é€‰é¡¹]')[1]?.split('[ç­”æ¡ˆ]')[0]?.trim(),
        answer: rawResponse.split('[ç­”æ¡ˆ]')[1]?.split('[è§£æ]')[0]?.trim(), explanation: rawResponse.split('[è§£æ]')[1]?.trim(),
        date: getTodayDateString(), topics: qModal.crossTopic.checked ? [planItem.section, 'ç»¼åˆé¢˜'] : selectedTopics
      };
      if (!q.question || !q.options || !q.answer || !q.explanation) throw new Error("AIè¿”å›çš„é¢˜ç›®æ ¼å¼ä¸å®Œæ•´ï¼Œè¯·é‡è¯•ã€‚");
      const history = storage.get('aiQuestionHistory', []);
      history.push(q);
      storage.set('aiQuestionHistory', history);
      const resultHTML = `<div class="prose prose-invert prose-p:text-slate-300 prose-strong:text-white"><h4>é¢˜ç›®</h4><p>${q.question}</p><h4 class="mt-4">é€‰é¡¹</h4><p class="whitespace-pre-wrap">${q.options}</p><div class="mt-4 pt-2 border-t border-slate-700/50"><strong class="text-green-400">æ­£ç¡®ç­”æ¡ˆ: ${q.answer}</strong><p class="mt-1">${q.explanation}</p></div></div>`;
      DOM.aiModal.title.textContent = 'âœ¨ éšå ‚ç»ƒä¹ ';
      DOM.aiModal.result.innerHTML = resultHTML;
      DOM.aiModal.loading.style.display = 'none';
      showModal(DOM.aiModal);
    } catch (error) {
      qModal.error.textContent = `å‡ºé¢˜å¤±è´¥: ${error.message}`;
      qModal.error.classList.remove('hidden');
    } finally {
      qModal.generateBtnText.textContent = 'ğŸš€ ç”Ÿæˆé¢˜ç›®';
      qModal.generateBtnSpinner.classList.add('hidden');
      qModal.generateBtn.disabled = false;
    }
  }

  async function handleAIPolish(textareaElement) {
    const noteContent = textareaElement.value;
    if (noteContent.trim() === "" || !ensureApiKey()) return;
    const nModal = DOM.notesModal;
    nModal.polishText.textContent = 'æ¶¦è‰²ä¸­...';
    nModal.polishSpinner.classList.remove('hidden');
    nModal.polishBtn.disabled = true;
    const formattingRules = "ä½ çš„å›å¤å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š\n(1) ä½¿ç”¨'(1)'ã€'(2)'è¿™æ ·çš„æ ¼å¼åˆ†ç‚¹ã€‚\n(2) æ‰€æœ‰åˆ†ç‚¹å’Œæ®µè½ä¹‹é—´ä¸å…è®¸å‡ºç°é¢å¤–çš„ç©ºè¡Œã€‚\n(3) å¦‚æœéœ€è¦å¼ºè°ƒæŸä¸ªå†…å®¹ï¼Œå¿…é¡»ä½¿ç”¨'**'å°†è¯¥å†…å®¹åŒ…è£¹èµ·æ¥ã€‚\nè¯·ç›´æ¥è¿”å›ä¼˜åŒ–åçš„ç¬”è®°å†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šè¯´æ˜æ–‡å­—ã€‚";
    const prompt = `ä½œä¸ºä¸€åé¡¶çº§çš„408è®¡ç®—æœºè€ƒç ”è¾…å¯¼è€å¸ˆï¼Œè¯·å°†ä»¥ä¸‹å­¦ç”Ÿç¬”è®°è¿›è¡Œä¼˜åŒ–ï¼Œä½¿å…¶ç»“æ„åŒ–ã€æ¦‚å¿µå‡†ç¡®ã€è¯­è¨€ç²¾ç‚¼ï¼Œæ›´é€‚åˆèƒŒè¯µå’Œè®°å¿†ã€‚å­¦ç”Ÿçš„åŸå§‹ç¬”è®°æ˜¯ï¼š\n\n"${noteContent}"\n\n${formattingRules}`;
    try {
      textareaElement.value = await callGemini(prompt);
      nModal.error.classList.add('hidden');
    } catch (error) {
      nModal.error.textContent = `AIæ¶¦è‰²å¤±è´¥: ${error.message}`;
      nModal.error.classList.remove('hidden');
    } finally {
      nModal.polishText.textContent = 'âœ¨ AI æ¶¦è‰²';
      nModal.polishSpinner.classList.add('hidden');
      nModal.polishBtn.disabled = false;
    }
  }

  function handleSmartSummary(dateStr) {
    const planData = storage.get(`plan_${dateStr}`);
    if (!planData || !planData.plan) return;
    const topicList = planData.plan.map(item => `${item.subject}çš„"${item.section}"`).join('ã€');
    handleAIButtonClick({ currentTarget: { dataset: { type: 'summary', topic: topicList } } });
  }

  function finishAndShowSummary(dateStr) {
    const planData = storage.get(`plan_${dateStr}`);
    if (planData) {
      planData.isFinished = true;
      storage.set(`plan_${dateStr}`, planData);
    }
    displaySummaryView(dateStr);
  }

  function showAPIKeyModal(forceShow = false) {
    if (!storage.get('apiKey') || forceShow) {
      DOM.apiKeyModal.input.value = storage.get('apiKey', '');
      DOM.apiKeyModal.error.classList.add('hidden');
      showModal(DOM.apiKeyModal);
    }
  }

  function handleReinforcePriority(topics) {
    if (!topics || topics.length === 0) return;
    const topicNames = topics.map(t => t.name);
    let priorityPool = storage.get('priorityReviewPool', []);
    let addedCount = 0;
    topicNames.forEach(name => {
      if (!priorityPool.includes(name)) {
        priorityPool.push(name);
        addedCount++;
      }
    });
    storage.set('priorityReviewPool', priorityPool);
    showNotification(`${addedCount}ä¸ªè–„å¼±ç‚¹å·²åŠ å…¥ä¼˜å…ˆå¤ä¹ æ± ï¼`);
  }

  async function handleReinforceAI(topics) {
    if (!ensureApiKey() || !topics || topics.length === 0) return;
    const topicNames = topics.map(t => t.name).join('ã€');
    const prompt = `ä½œä¸ºä¸€å408è€ƒç ”å‘½é¢˜ä¸“å®¶ï¼Œè¯·ä¸“é—¨é’ˆå¯¹ä»¥ä¸‹å‡ ä¸ªçŸ¥è¯†ç‚¹ï¼š[${topicNames}]ï¼Œå‡ºä¸€ç»„ï¼ˆ2-3é“ï¼‰é«˜è´¨é‡çš„å•é¡¹é€‰æ‹©é¢˜ï¼Œå¸®åŠ©æˆ‘å·©å›ºè–„å¼±é¡¹ã€‚\n\nä½ çš„å›å¤å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™çš„æ–‡å­—è¯´æ˜:\n[é¢˜ç›®]\né¢˜ç›®å†…å®¹\n[é€‰é¡¹]\nA) é€‰é¡¹A\nB) é€‰é¡¹B\nC) é€‰é¡¹C\nD) é€‰é¡¹D\n[ç­”æ¡ˆ]\næ­£ç¡®é€‰é¡¹å­—æ¯\n[è§£æ]\nè¯¦ç»†è§£æå†…å®¹\n\n---\n\n[é¢˜ç›®]\n...`;

    DOM.aiModal.title.textContent = 'âœ¨ è–„å¼±ç‚¹ä¸“é¡¹ç»ƒä¹ ';
    DOM.aiModal.loading.style.display = 'flex';
    DOM.aiModal.result.innerHTML = '';
    showModal(DOM.aiModal);
    try {
      const text = await callGemini(prompt);
      const questionsHTML = text.split('\n---\n').map(qText => {
        const q = { question: qText.split('[é¢˜ç›®]')[1]?.split('[é€‰é¡¹]')[0]?.trim(), options: qText.split('[é€‰é¡¹]')[1]?.split('[ç­”æ¡ˆ]')[0]?.trim(), answer: qText.split('[ç­”æ¡ˆ]')[1]?.split('[è§£æ]')[0]?.trim(), explanation: qText.split('[è§£æ]')[1]?.trim() };
        if (!q.question || !q.options || !q.answer || !q.explanation) return '<p>AIè¿”å›çš„é¢˜ç›®æ ¼å¼ä¸å®Œæ•´ï¼Œè¯·é‡è¯•ã€‚</p>';
        return `<div class="prose prose-invert prose-p:text-slate-300 prose-strong:text-white"><h4>é¢˜ç›®</h4><p>${q.question}</p><h4 class="mt-4">é€‰é¡¹</h4><p class="whitespace-pre-wrap">${q.options}</p><div class="mt-4 pt-2 border-t border-slate-700/50"><strong class="text-green-400">æ­£ç¡®ç­”æ¡ˆ: ${q.answer}</strong><p class="mt-1">${q.explanation}</p></div></div>`;
      }).join('<hr class="my-4 border-slate-600">');
      DOM.aiModal.result.innerHTML = questionsHTML;
    } catch (error) {
      DOM.aiModal.result.innerHTML = `æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹å‡ºé”™äº†ã€‚<br>é”™è¯¯ä¿¡æ¯: ${error.message}`;
    } finally {
      DOM.aiModal.loading.style.display = 'none';
    }
  }

  async function handleReviewConcepts(topics) {
    if (!ensureApiKey() || !topics || topics.length === 0) return;
    const topicStr = topics.join('ã€');
    const prompt = `ä½œä¸ºä¸€åé¡¶çº§çš„408è®¡ç®—æœºè€ƒç ”è¾…å¯¼è€å¸ˆï¼Œè¯·ä¸ºæˆ‘æ€»ç»“ä¸€ä¸‹ä¸ä»¥ä¸‹çŸ¥è¯†ç‚¹ç›¸å…³çš„æ ¸å¿ƒæ¦‚å¿µå’Œå…³é”®ç‚¹ï¼š[${topicStr}]ã€‚æ€»ç»“è¦ç²¾ç‚¼ã€æ¡ç†æ¸…æ™°ï¼Œé€‚åˆå¿«é€Ÿå›é¡¾ã€‚`;
    DOM.aiModal.title.textContent = `âœ¨ çŸ¥è¯†ç‚¹å›é¡¾: ${topicStr}`;
    DOM.aiModal.loading.style.display = 'flex';
    DOM.aiModal.result.innerHTML = '';
    showModal(DOM.aiModal);
    try {
      const text = await callGemini(prompt);
      DOM.aiModal.result.innerHTML = text.replace(/\n/g, '<br>');
    } catch (error) {
      DOM.aiModal.result.innerHTML = `æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹å‡ºé”™äº†ã€‚<br>é”™è¯¯ä¿¡æ¯: ${error.message}`;
    } finally {
      DOM.aiModal.loading.style.display = 'none';
    }
  }

  function displayLearningCard(planIndex, dateStr) {
    const planData = storage.get(`plan_${dateStr}`);
    const item = planData.plan[planIndex];
    if (!item) return;
    const card = DOM.learningCardModal;
    card.title.textContent = item.section;
    // The learning card now shows all notes for that item, separated by a line
    card.notes.value = (item.notes || []).join('\n\n---\n\n');
    card.aiOutput.innerHTML = 'è¯·é€‰æ‹©ä¸€ä¸ª AI å·¥å…·å¼€å§‹å­¦ä¹ ...';

    card.saveNoteBtn.onclick = () => {
      // Save all notes back from the text area
      item.notes = card.notes.value.split('\n\n---\n\n').map(s => s.trim()).filter(Boolean);
      storage.set(`plan_${dateStr}`, planData);
      showNotification('ç¬”è®°å·²ä¿å­˜ï¼');
      // After saving in the learning card, also update the main plan view UI
      const notesContainerId = `notes-container-${dateStr.replace(/-/g, '')}-${planIndex}`;
      const notesContainer = document.getElementById(notesContainerId);
      updateNotesUI(notesContainer, dateStr, planIndex);
    };
    card.polishBtn.onclick = () => handleAIPolish(card.notes);
    card.aiBtns.forEach(btn => {
      btn.onclick = async () => {
        const type = btn.dataset.type;
        if (!ensureApiKey()) return;
        card.aiOutput.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>';
        let prompt = '';
        const formattingRules = "ä½ çš„å›å¤å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š\n(1) å¦‚æœæœ‰æ ‡é¢˜ï¼Œæ ‡é¢˜å’Œæ­£æ–‡ä¹‹é—´å¿…é¡»æœ‰ä¸”ä»…æœ‰ä¸€è¡Œç©ºè¡Œã€‚\n(2) æ­£æ–‡åˆ†ç‚¹è¯´æ˜å¿…é¡»ä½¿ç”¨'(1)'ã€'(2)'è¿™æ ·çš„æ ¼å¼å¼€å¤´ã€‚\n(3) æ‰€æœ‰åˆ†ç‚¹å’Œæ®µè½ä¹‹é—´ä¸å…è®¸å‡ºç°é¢å¤–çš„ç©ºè¡Œã€‚\n(4) å¦‚æœéœ€è¦å¼ºè°ƒæŸä¸ªå†…å®¹ï¼Œå¿…é¡»ä½¿ç”¨'**'å°†è¯¥å†…å®¹åŒ…è£¹èµ·æ¥ã€‚\nè¯·ç›´æ¥è¾“å‡ºæ ¼å¼åŒ–åçš„å†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•é¢å¤–çš„è§£é‡Šè¯´æ˜æ–‡å­—ã€‚";

        if (type === 'explain') prompt = `ä½œä¸ºä¸€åé¡¶çº§çš„408è®¡ç®—æœºè€ƒç ”è¾…å¯¼è€å¸ˆï¼Œè¯·ä¸ºå­¦ç”Ÿæä¾›â€œ${item.section}â€è¿™ä¸ªçŸ¥è¯†ç‚¹çš„æ·±å…¥è§£æã€‚å†…å®¹åº”åŒ…æ‹¬æ ¸å¿ƒå®šä¹‰ã€å…³é”®ç‰¹å¾æˆ–æ­¥éª¤ã€ä»¥åŠå…¸å‹åº”ç”¨åœºæ™¯ã€‚\n\n${formattingRules}`;
        else if (type === 'question') {
          const syllabusEntry = SYLLABUS.find(s => s[2] === item.section);
          const coreTopic = syllabusEntry ? syllabusEntry[5][0] : item.section;
          prompt = `ä½œä¸ºä¸€å408è€ƒç ”å‘½é¢˜ä¸“å®¶ï¼Œè¯·ä¸¥æ ¼å›´ç»•æ ¸å¿ƒè€ƒç‚¹ï¼š[${coreTopic}]ï¼Œå‡ºä¸€é“é«˜è´¨é‡çš„å•é¡¹é€‰æ‹©é¢˜ã€‚\n\nä½ çš„å›å¤å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å¤šä½™çš„æ–‡å­—è¯´æ˜:\n[é¢˜ç›®]\né¢˜ç›®å†…å®¹\n[é€‰é¡¹]\nA) é€‰é¡¹A\nB) é€‰é¡¹B\nC) é€‰é¡¹C\nD) é€‰é¡¹D\n[ç­”æ¡ˆ]\næ­£ç¡®é€‰é¡¹å­—æ¯\n[è§£æ]\nè¯¦ç»†è§£æå†…å®¹`;
        } else if (type === 'mnemonic') {
          prompt = `ä½œä¸ºä¸€åé¡¶çº§çš„408è®¡ç®—æœºè€ƒç ”è¾…å¯¼è€å¸ˆï¼Œè¯·ä¸ºâ€œ${item.section}â€è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œåˆ›é€ ä¸€ä¸ªæœ—æœ—ä¸Šå£çš„ã€ä¾¿äºè®°å¿†çš„åŠ©è®°æç¤ºï¼ˆæ¯”å¦‚å£è¯€ã€æ¯”å–»ã€è°éŸ³ç­‰ï¼‰ã€‚\n\n${formattingRules}`;
        }
        try {
          const rawText = await callGemini(prompt);
          card.aiOutput.innerHTML = rawText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        } catch (error) {
          card.aiOutput.innerHTML = `æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹å‡ºé”™äº†ã€‚<br>é”™è¯¯ä¿¡æ¯: ${error.message}`;
        }
      };
    });
    card.completeBtn.onclick = () => {
      handleTaskCompletionToggle({ currentTarget: { dataset: { planIndex } }, stopPropagation: () => {} }, dateStr, true);
      hideModal(card);
    };
    showModal(card);
  }

  // --- é¡µé¢åŠ è½½é€»è¾‘ ---
  document.addEventListener('DOMContentLoaded', () => {
    // Cache DOM elements
    DOM.aiModal = { backdrop: document.getElementById('ai-modal-backdrop'), title: document.getElementById('ai-modal-title'), loading: document.getElementById('ai-loading'), result: document.getElementById('ai-result') };
    DOM.notesModal = { backdrop: document.getElementById('notes-modal-backdrop'), title: document.getElementById('notes-modal-title'), textarea: document.getElementById('notes-textarea'), saveBtn: document.getElementById('save-note-btn'), polishBtn: document.getElementById('ai-polish-btn'), polishSpinner: document.getElementById('ai-polish-spinner'), polishText: document.getElementById('ai-polish-text'), error: document.getElementById('notes-error') };
    DOM.apiKeyModal = { backdrop: document.getElementById('api-key-modal-backdrop'), input: document.getElementById('api-key-input'), saveBtn: document.getElementById('save-api-key-btn'), laterBtn: document.getElementById('api-key-later'), error: document.getElementById('api-key-error')};
    DOM.questionOptionsModal = { backdrop: document.getElementById('question-options-modal-backdrop'), list: document.getElementById('sub-topics-list'), selectAll: document.getElementById('select-all-topics'), crossTopic: document.getElementById('cross-topic-checkbox'), generateBtn: document.getElementById('generate-question-btn'), generateBtnText: document.getElementById('generate-q-text'), generateBtnSpinner: document.getElementById('generate-q-spinner'), error: document.getElementById('question-options-error') };
    DOM.confirmModal = { backdrop: document.getElementById('confirm-modal-backdrop'), title: document.getElementById('confirm-modal-title'), text: document.getElementById('confirm-modal-text'), okBtn: document.getElementById('confirm-ok-btn'), cancelBtn: document.getElementById('confirm-cancel-btn') };
    DOM.learningCardModal = { backdrop: document.getElementById('learning-card-backdrop'), title: document.getElementById('learning-card-title'), notes: document.getElementById('learning-card-notes'), saveNoteBtn: document.getElementById('learning-card-save-note-btn'), polishBtn: document.getElementById('learning-card-polish-btn'), aiOutput: document.getElementById('learning-card-ai-output'), aiBtns: document.querySelectorAll('.learning-card-ai-btn'), completeBtn: document.getElementById('learning-card-complete-btn') };
    DOM.toast = document.getElementById('toast-notification');

    // Setup modals
    Object.values(DOM).forEach(modal => { if(modal.backdrop) setupModal(modal); });

    DOM.apiKeyModal.saveBtn.addEventListener('click', () => {
      const key = DOM.apiKeyModal.input.value.trim();
      if (key) {
        storage.set('apiKey', key);
        hideModal(DOM.apiKeyModal);
        showNotification('API å¯†é’¥å·²ä¿å­˜ï¼');
      } else {
        DOM.apiKeyModal.error.textContent = "APIå¯†é’¥ä¸èƒ½ä¸ºç©ºã€‚";
        DOM.apiKeyModal.error.classList.remove('hidden');
      }
    });
    DOM.apiKeyModal.laterBtn.addEventListener('click', () => hideModal(DOM.apiKeyModal));
    document.getElementById('settings-icon').addEventListener('click', () => showAPIKeyModal(true));
    DOM.questionOptionsModal.selectAll.addEventListener('change', (e) => DOM.questionOptionsModal.list.querySelectorAll('.sub-topic-checkbox').forEach(checkbox => checkbox.checked = e.target.checked));

    // Main App Logic
    displayDashboard();
    showAPIKeyModal();
  });
</script>

</body>
</html>

